<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RealFutbol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, setDoc, updateDoc, increment, getDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDiRY9xyTiQWeJuFCjU7CTBDWcJxDUcVVo",
            authDomain: "real-futbol-950e9.firebaseapp.com",
            projectId: "real-futbol-950e9",
            storageBucket: "real-futbol-950e9.firebasestorage.app",
            messagingSenderId: "997733956346",
            appId: "1:997733956346:web:af680c55a189c9114fe743",
            measurementId: "G-JNGMN81PHB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Exponer globalmente
        window.firebaseDB = db;
        window.firebaseAuth = auth;
        window.firebaseLogin = signInAnonymously;
        window.firebaseAuthListener = onAuthStateChanged;
        window.firebaseMethods = { collection, doc, addDoc, onSnapshot, setDoc, updateDoc, increment, getDoc, serverTimestamp, query, orderBy };
    </script>

    <style>
        :root {
            --bg-main: #000000;
            --bg-card: #0f0f0f;
            --border: #333333;
            --text-main: #ffffff;
            --text-muted: #888888;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* Tipografía Deportiva */
        .font-sport { font-family: 'Chakra Petch', sans-serif; }
        
        /* Tarjetas Minimalistas B&W */
        .match-card { 
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        /* Hover efecto blanco */
        .match-card.clickable:hover { 
            border-color: #ffffff; 
            background-color: #1a1a1a;
            cursor: pointer;
        }
        .match-card.not-clickable { opacity: 1; cursor: default; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

        /* Toggle Switch B&W */
        .toggle-checkbox:checked { right: 0; border-color: #fff; }
        .toggle-checkbox:checked + .toggle-label { background-color: #fff; }
        .toggle-label { background-color: #000; border: 1px solid #444; }

        /* Cancha Táctica B&W */
        .football-pitch { 
            background-color: #151515; /* Gris muy oscuro */
            border: 2px solid #444; 
            position: relative; width: 100%; aspect-ratio: 7 / 5; 
            border-radius: 4px; overflow: hidden; 
        }
        .pitch-line { position: absolute; background-color: #444; }
        .center-line { top: 0; bottom: 0; left: 50%; width: 1px; transform: translateX(-50%); }
        .center-circle { top: 50%; left: 50%; width: 20%; height: 28%; border: 1px solid #444; border-radius: 50%; transform: translate(-50%, -50%); }
        .penalty-box { position: absolute; border: 1px solid #444; width: 15%; height: 40%; top: 30%; }
        .home-box { left: 0; border-left: none; }
        .away-box { right: 0; border-right: none; }
        
        /* Marcadores Jugadores B&W */
        .player-marker { 
            position: absolute; width: 26px; height: 26px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 800; font-size: 10px; 
            z-index: 10; transition: transform 0.2s; cursor: pointer;
            border: 1px solid #000;
        }
        .home-player { background-color: #ffffff; color: #000000; }
        .away-player { background-color: #333333; color: #ffffff; border: 1px solid #fff; }
        .player-marker:active { transform: scale(1.3); z-index: 20; }

        /* Tabs */
        .tab-btn { color: #666; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #fff; border-bottom-color: #fff; }
        
        /* Loader B&W */
        .loader { width: 32px; height: 32px; border: 3px solid #333; border-bottom-color: #fff; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Botón Flotante Fijo */
        .btn-float-back {
            position: fixed; top: 16px; left: 16px; z-index: 100;
            background: #000; 
            border: 1px solid #444; color: white;
            padding: 10px; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .btn-float-back:hover { background-color: #222; border-color: #fff; }
        
        .font-tnum { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        /* Live Pulse Blanco */
        .live-dot { height: 6px; width: 6px; background-color: #fff; border-radius: 50%; display: inline-block; margin-right: 4px; vertical-align: middle; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.4; transform: scale(0.8); } }

        /* Override Select */
        select { background-color: #000; color: white; border-color: #333; }
        
        /* Botón Principal Blanco */
        .btn-primary { 
            background-color: #ffffff; color: #000000; font-weight: bold; 
            border: 1px solid #fff; transition: all 0.2s;
        }
        .btn-primary:hover { background-color: #ccc; border-color: #ccc; }

        /* Backdrop Móvil */
        .mobile-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 40; backdrop-filter: blur(4px); }

        /* Chat Styles - BOTTOM SHEET */
        #chat-modal {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #chat-modal.hidden {
            transform: translateY(100%);
        }
        
        /* Mobile: Bottom Sheet */
        .chat-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 75vh;
            background-color: #050505;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border-top: 1px solid #333;
            z-index: 80;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
        }
        
        /* Desktop: Floating Side Panel */
        @media (min-width: 1024px) {
            .chat-container {
                right: 20px;
                left: auto;
                bottom: 20px;
                width: 400px;
                height: 600px;
                border-radius: 12px;
                border: 1px solid #333;
            }
        }

        .chat-bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 0.85rem; line-height: 1.3; position: relative; word-wrap: break-word; }
        .chat-own { background-color: #fff; color: #000; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-other { background-color: #222; color: #fff; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #333; }
        .chat-name { font-size: 0.65rem; margin-bottom: 2px; opacity: 0.7; font-weight: bold; }
        .chat-time { font-size: 0.6rem; margin-top: 2px; opacity: 0.5; text-align: right; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- HEADER SIMÉTRICO -->
    <header class="h-14 border-b border-[#222] bg-black flex items-center justify-between px-4 z-40 shrink-0 relative">
        <div class="flex items-center w-12">
            <button id="mobile-menu-btn" class="text-white p-1 rounded hover:bg-[#222]">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
        </div>
        <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center justify-center cursor-pointer" onclick="window.location.reload()">
            <img src="https://i.postimg.cc/pL6B4Mpr/real-futbol-removebg-preview.png" alt="Real Futbol Logo" class="h-14 object-contain ml-10">
        </div>
        <div class="flex items-center justify-end w-12">
            <div class="relative inline-block w-8 h-5 align-middle select-none">
                <input type="checkbox" id="live-toggle" class="toggle-checkbox absolute block w-3 h-3 mt-1 ml-1 rounded-full bg-white border-none appearance-none cursor-pointer transition-all duration-300 left-0"/>
                <label for="live-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-[#222] cursor-pointer border border-[#444]"></label>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <div id="mobile-backdrop" class="mobile-backdrop hidden lg:hidden"></div>
        <div id="chat-backdrop" class="mobile-backdrop hidden" onclick="app.closeChat()"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-[280px] bg-black border-r border-[#222] flex flex-col transform -translate-x-full lg:translate-x-0 lg:static lg:w-72 transition-transform duration-300 z-50 h-full shadow-2xl">
            <div class="p-5 border-b border-[#222] flex justify-between items-center lg:hidden">
                <h2 class="font-bold text-white text-lg uppercase tracking-widest font-sport">Menu</h2>
                <button id="close-sidebar" class="text-white p-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            </div>
            
            <div class="overflow-y-auto flex-1 p-3 space-y-1">
                <div class="px-3 py-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Competiciones</div>
                <button onclick="app.showStandings(128, 'Liga Profesional')" class="league-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 hover:bg-[#1a1a1a] hover:text-white transition-all"><img src="https://media.api-sports.io/football/leagues/128.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">Liga Argentina</span></button>
                <button onclick="app.showStandings(1032, 'Copa de la Liga')" class="league-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 hover:bg-[#1a1a1a] hover:text-white transition-all"><img src="https://media.api-sports.io/football/leagues/1032.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">Copa de la Liga</span></button>
                <button onclick="app.showStandings(129, 'Primera Nacional')" class="league-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 hover:bg-[#1a1a1a] hover:text-white transition-all"><img src="https://media.api-sports.io/football/leagues/129.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">Primera Nacional</span></button>
                <button onclick="app.showStandings(71, 'Brasileirão')" class="league-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 hover:bg-[#1a1a1a] hover:text-white transition-all"><img src="https://media.api-sports.io/football/leagues/71.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">Brasileirão A</span></button>
                <div class="my-2 border-t border-[#222]"></div>
                <button onclick="app.showStandings(39, 'Premier League')" class="league-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 hover:bg-[#1a1a1a] hover:text-white transition-all"><img src="https://media.api-sports.io/football/leagues/39.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">Premier League</span></button>
                <button onclick="app.showStandings(140, 'La Liga')" class="league-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 hover:bg-[#1a1a1a] hover:text-white transition-all"><img src="https://media.api-sports.io/football/leagues/140.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">La Liga</span></button>
                <button onclick="app.showStandings(78, 'Bundesliga')" class="league-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 hover:bg-[#1a1a1a] hover:text-white transition-all"><img src="https://media.api-sports.io/football/leagues/78.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">Bundesliga</span></button>

                <div class="mt-8 px-2">
                    <button onclick="app.navigateToMatches()" class="w-full btn-primary py-3 px-4 text-xs uppercase tracking-widest shadow-lg">Partidos de Hoy</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative w-full lg:w-auto overflow-hidden bg-black">
            
            <!-- Date Navigation -->
            <div id="date-nav" class="border-b border-[#222] p-3 z-10 sticky top-0 bg-black/95 backdrop-blur">
                <div class="flex items-center justify-between mb-3 max-w-lg mx-auto">
                    <button onclick="app.changeDate(-1)" class="p-2 text-gray-400 hover:text-white hover:bg-[#222] rounded transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <div class="text-center cursor-pointer" onclick="app.resetDate()">
                        <h2 id="current-month" class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-0.5">MES</h2>
                        <div id="current-day-text" class="text-lg font-bold text-white leading-none font-sport">HOY</div>
                    </div>
                    <button onclick="app.changeDate(1)" class="p-2 text-gray-400 hover:text-white hover:bg-[#222] rounded transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </div>
                <div id="calendar-days" class="flex justify-between max-w-lg mx-auto gap-1"></div>
            </div>

            <div id="main-content" class="flex-1 overflow-y-auto p-4 relative scroll-smooth">
                <div id="view-match-list" class="max-w-3xl mx-auto space-y-6 animate-fade-in pb-24"></div>

                <!-- Standings -->
                <div id="view-standings" class="hidden max-w-4xl mx-auto animate-fade-in pb-24">
                    <div class="flex flex-col gap-4 mb-6 sticky top-0 z-20 bg-black/95 backdrop-blur py-2 border-b border-[#222]">
                        <div class="flex items-center justify-between px-1">
                            <div class="flex items-center gap-3">
                                <button onclick="app.navigateToMatches()" class="lg:hidden p-1 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                                <h2 id="standings-title" class="text-xl font-bold text-white uppercase tracking-wider font-sport">Tabla</h2>
                            </div>
                            <select id="season-selector" onchange="app.changeSeason(this.value)" class="bg-[#111] text-white text-sm border border-[#333] p-1 px-2 rounded focus:outline-none font-mono">
                                <option value="2025">2025</option>
                                <option value="2024" selected>2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        <div id="standings-tabs" class="flex overflow-x-auto gap-2 px-1 no-scrollbar hidden"></div>
                    </div>
                    <div id="standings-container" class="space-y-6"></div>
                </div>

                <!-- Match Detail Overlay -->
                <div id="view-match-detail" class="hidden fixed inset-0 bg-black z-[60] overflow-y-auto animate-fade-in">
                    <div class="max-w-4xl mx-auto min-h-full bg-[#050505] relative">
                        <button onclick="app.closeDetail()" class="btn-float-back hover:bg-[#222] transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                        <div id="detail-loader" class="hidden py-40 text-center"><div class="loader"></div></div>
                        <div id="detail-content-wrapper" class="pt-16 pb-20">
                            <div class="relative p-6 text-center border-b border-[#222] bg-[#0a0a0a]">
                                <div class="flex justify-between items-center max-w-md mx-auto">
                                    <div class="flex-1 flex flex-col items-center gap-3">
                                        <img id="detail-home-logo" src="" class="w-16 h-16 object-contain">
                                        <h3 id="detail-home-name" class="font-bold text-sm leading-tight text-white uppercase">Home</h3>
                                    </div>
                                    <div class="px-4 flex flex-col items-center">
                                        <div class="text-4xl font-black text-white tracking-tighter flex items-center gap-2 score-font">
                                            <span id="detail-home-score">-</span><span class="text-gray-600 text-2xl">:</span><span id="detail-away-score">-</span>
                                        </div>
                                        <div id="detail-status" class="mt-2 text-[10px] font-bold text-gray-500 uppercase tracking-widest">VS</div>
                                    </div>
                                    <div class="flex-1 flex flex-col items-center gap-3">
                                        <img id="detail-away-logo" src="" class="w-16 h-16 object-contain">
                                        <h3 id="detail-away-name" class="font-bold text-sm leading-tight text-white uppercase">Away</h3>
                                    </div>
                                </div>
                                <div id="detail-header-scorers" class="mt-6 flex justify-between max-w-md mx-auto text-xs text-gray-500 font-mono border-t border-[#222] pt-4">
                                    <div id="detail-home-scorers-list" class="flex-1 text-right pr-4 space-y-1"></div>
                                    <div id="detail-away-scorers-list" class="flex-1 text-left pl-4 space-y-1"></div>
                                </div>
                            </div>
                            <div class="flex border-b border-[#222] sticky top-[57px] bg-black/95 backdrop-blur z-30 overflow-x-auto no-scrollbar">
                                <button class="flex-1 py-3 px-4 text-xs font-bold text-white border-b-2 border-white tab-btn whitespace-nowrap uppercase" data-target="tab-timeline">Timeline</button>
                                <button class="flex-1 py-3 px-4 text-xs font-bold text-gray-500 hover:text-gray-300 tab-btn whitespace-nowrap uppercase" data-target="tab-lineups">Alineaciones</button>
                                <button class="flex-1 py-3 px-4 text-xs font-bold text-gray-500 hover:text-gray-300 tab-btn whitespace-nowrap uppercase" data-target="tab-stats">Stats</button>
                            </div>
                            <div class="p-4 lg:p-8 space-y-6 min-h-[50vh]">
                                <div id="tab-timeline" class="tab-content block space-y-4 max-w-2xl mx-auto"></div>
                                <div id="tab-lineups" class="tab-content hidden max-w-2xl mx-auto">
                                    <div class="football-pitch mx-auto" id="football-pitch"><div class="center-line"></div><div class="center-circle"></div><div class="penalty-box home-box"></div><div class="penalty-box away-box"></div></div>
                                    <div class="grid grid-cols-2 gap-4 mt-6">
                                        <div class="bg-[#111] p-4 rounded border border-[#222]"><h4 class="text-white font-bold border-b border-[#333] pb-2 mb-2 text-xs uppercase tracking-wider">Local</h4><div id="lineup-home-list" class="space-y-2 text-xs text-gray-400 font-mono"></div></div>
                                        <div class="bg-[#111] p-4 rounded border border-[#222]"><h4 class="text-white font-bold border-b border-[#333] pb-2 mb-2 text-right text-xs uppercase tracking-wider">Visitante</h4><div id="lineup-away-list" class="space-y-2 text-xs text-gray-400 text-right font-mono"></div></div>
                                    </div>
                                </div>
                                <div id="tab-stats" class="tab-content hidden space-y-4 max-w-xl mx-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Player Modal -->
    <div id="player-modal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-[#111] border border-[#333] rounded-none w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="bg-black p-5 flex justify-between items-center border-b border-[#222]">
                <h3 id="modal-player-name" class="font-bold text-white text-lg font-mono uppercase">Jugador</h3>
                <button onclick="document.getElementById('player-modal').classList.add('hidden')" class="text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-white rounded-full mx-auto mb-4 flex items-center justify-center text-black font-bold text-2xl">#</div>
                <p class="text-gray-400 text-sm uppercase tracking-wider">Detalles no disponibles</p>
            </div>
        </div>
    </div>

    <!-- Chat Modal (Bottom Sheet Style) -->
    <div id="chat-modal" class="hidden chat-container z-[80]">
        <!-- Chat Header -->
        <div class="bg-[#111] border-b border-[#333] p-3 flex items-center justify-between shrink-0 shadow-xl rounded-t-xl cursor-pointer" onclick="app.closeChat()">
            <div class="flex items-center gap-3">
                <button onclick="app.closeChat(); event.stopPropagation()" class="p-2 text-white hover:bg-[#222] rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </button>
                <div>
                    <h3 id="chat-match-title" class="font-bold text-white text-xs uppercase">Foro en Vivo</h3>
                    <div class="flex items-center gap-1.5">
                        <span class="live-dot w-1.5 h-1.5 bg-green-500"></span>
                        <span class="text-[9px] text-gray-400 uppercase tracking-widest">En directo</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-black flex flex-col">
            <div class="text-center py-10 text-gray-600 text-xs uppercase tracking-widest">Cargando comentarios...</div>
        </div>

        <!-- Input Area -->
        <div class="bg-[#111] border-t border-[#333] p-3 shrink-0 pb-safe">
            <form id="chat-form" onsubmit="app.sendMessage(event)" class="flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-[#050505] border border-[#333] rounded-full px-4 py-3 text-sm text-white focus:outline-none focus:border-white transition-colors" placeholder="Escribe un comentario..." autocomplete="off">
                <button type="submit" id="chat-send-btn" class="bg-white text-black rounded-full w-12 h-12 flex items-center justify-center font-bold hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transform rotate-90 ml-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Name Modal -->
    <div id="name-modal" class="fixed inset-0 bg-black/95 z-[90] hidden flex items-center justify-center p-6 backdrop-blur">
        <div class="bg-[#111] border border-[#333] p-6 w-full max-w-sm rounded-lg text-center">
            <h3 class="text-white font-bold text-lg mb-2">Únete al Foro</h3>
            <p class="text-gray-400 text-sm mb-6">Elige un nombre para comentar anonimamente.</p>
            <input type="text" id="username-input" class="w-full bg-black border border-[#333] rounded p-3 text-white text-center font-bold mb-4 focus:border-white outline-none" placeholder="Tu Apodo">
            <button onclick="app.saveName()" class="w-full btn-primary py-3 font-bold uppercase text-sm">Entrar al Chat</button>
        </div>
    </div>

    <script>
        const API_KEY = "1d6013be5112e78ac0ee1c138fbad117";
        const BACKUP_KEY = "8f6b9c9d9c9d9c9d9c9d9c9d9c9d9c9d"; 
        const API_BASE = "https://v3.football.api-sports.io";
        const CACHE_TIME = 10 * 60 * 1000;
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'real-futbol-v1';

        const fetchAPI = async (endpoint) => {
            const cacheKey = "bw_v3_" + endpoint;
            const cached = localStorage.getItem(cacheKey);
            if(cached){
                const {ts, data} = JSON.parse(cached);
                if(Date.now() - ts < CACHE_TIME) return data;
            }
            
            let currentKey = API_KEY;
            let res = await fetch(`${API_BASE}${endpoint}`, { headers: { "x-apisports-key": currentKey } });
            let data = await res.json();

            if(data.message && data.message.includes("quota")) {
                res = await fetch(`${API_BASE}${endpoint}`, { headers: { "x-apisports-key": BACKUP_KEY } });
                data = await res.json();
            }
            
            if(data.errors && Object.keys(data.errors).length > 0) {
                if(endpoint.includes('fixtures')) return getMockMatches();
                throw new Error("API Limit");
            }
            
            localStorage.setItem(cacheKey, JSON.stringify({ts: Date.now(), data}));
            return data;
        };

        const getMockMatches = () => ({
            response: [
                { 
                    fixture: { id: 1, date: new Date().toISOString(), status: { short: 'LIVE', elapsed: 55, long: 'En Vivo' }, timestamp: Date.now() }, 
                    league: { id: 128, name: 'Liga Profesional', logo: 'https://media.api-sports.io/football/leagues/128.png' }, 
                    teams: { home: { id: 1, name: 'Boca Juniors', logo: 'https://media.api-sports.io/football/teams/451.png' }, away: { id: 2, name: 'River Plate', logo: 'https://media.api-sports.io/football/teams/435.png' } }, 
                    goals: { home: 1, away: 0 }, 
                    events: [{ type: 'Goal', time: { elapsed: 15 }, team: { id: 1 }, player: { name: 'E. Cavani' } }] 
                }
            ]
        });

        const state = {
            date: new Date(),
            matches: [],
            liveOnly: false,
            selectedLeague: null,
            season: 2024,
            standingsData: null,
            user: null,
            currentChatId: null,
            chatUnsubscribe: null,
            chatCounts: {},
            countsUnsubscribe: null
        };

        const formatDate = (d) => d.toISOString().split('T')[0];
        const getDayName = (d) => d.toLocaleDateString('es-AR', {weekday:'short'}).toUpperCase().replace('.','');
        
        window.app = {
            init: async () => {
                app.renderCalendar();
                app.loadMatches();

                // Initialize Auth Listener correctly
                if (window.firebaseAuthListener && window.firebaseAuth) {
                    window.firebaseAuthListener(window.firebaseAuth, (user) => {
                        if (user) {
                            state.user = user;
                            console.log("Logged in:", user.uid);
                            app.listenToChatCounts();
                        } else {
                            // Only sign in if strictly needed, avoid loops
                            if (window.firebaseLogin) {
                                window.firebaseLogin(window.firebaseAuth).catch(e => console.error(e));
                            }
                        }
                    });
                }

                // UI Event Listeners
                document.getElementById('mobile-menu-btn').onclick = () => {
                    document.getElementById('sidebar').classList.remove('-translate-x-full');
                    document.getElementById('mobile-backdrop').classList.remove('hidden');
                };
                const closeMenu = () => {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                    document.getElementById('mobile-backdrop').classList.add('hidden');
                };
                document.getElementById('close-sidebar').onclick = closeMenu;
                document.getElementById('mobile-backdrop').onclick = closeMenu;
                
                document.getElementById('live-toggle').onchange = (e) => {
                    state.liveOnly = e.target.checked;
                    app.renderMatches();
                };

                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        document.querySelectorAll('.tab-btn').forEach(b => {
                            b.classList.remove('text-white', 'border-b-2', 'border-white');
                            b.classList.add('text-gray-500');
                        });
                        e.target.classList.add('text-white', 'border-b-2', 'border-white');
                        e.target.classList.remove('text-gray-500');
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                        document.getElementById(e.target.dataset.target).classList.remove('hidden');
                    };
                });

                setInterval(() => app.loadMatches(true), 60000);
            },

            listenToChatCounts: () => {
                if (state.countsUnsubscribe) state.countsUnsubscribe();
                const { collection, onSnapshot } = window.firebaseMethods;
                
                // Listening to specific stats collection
                const countsRef = collection(window.firebaseDB, 'artifacts', APP_ID, 'public', 'data', 'chat_counts');
                
                state.countsUnsubscribe = onSnapshot(countsRef, (snapshot) => {
                    const counts = {};
                    snapshot.forEach(doc => {
                        counts[doc.id] = doc.data().count || 0;
                    });
                    state.chatCounts = counts;
                    app.updateBadges();
                }, (error) => {
                    console.log("Error listening to counts (likely empty collection initially):", error);
                });
            },

            updateBadges: () => {
                document.querySelectorAll('.chat-badge').forEach(el => {
                    const matchId = el.dataset.matchId;
                    if (state.chatCounts[matchId]) {
                        el.innerText = state.chatCounts[matchId];
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });
            },

            openChat: (e, matchId, homeName, awayName) => {
                if(e) e.stopPropagation();
                
                const name = localStorage.getItem('rf_username');
                if (!name) {
                    state.pendingChat = { matchId, homeName, awayName };
                    document.getElementById('name-modal').classList.remove('hidden');
                    return;
                }

                state.currentChatId = matchId;
                document.getElementById('chat-match-title').innerText = `${homeName} vs ${awayName}`;
                
                // Show modal (Bottom Sheet logic)
                const modal = document.getElementById('chat-modal');
                const backdrop = document.getElementById('chat-backdrop');
                modal.classList.remove('hidden');
                backdrop.classList.remove('hidden');
                
                // Slide in animation delay slightly
                requestAnimationFrame(() => {
                    modal.style.transform = 'translateY(0)';
                });

                document.body.style.overflow = 'hidden';
                app.loadChatMessages(matchId);
            },

            saveName: () => {
                const name = document.getElementById('username-input').value.trim();
                if (name.length < 2) return alert("El nombre es muy corto");
                localStorage.setItem('rf_username', name);
                document.getElementById('name-modal').classList.add('hidden');
                if (state.pendingChat) {
                    app.openChat(null, state.pendingChat.matchId, state.pendingChat.homeName, state.pendingChat.awayName);
                    state.pendingChat = null;
                }
            },

            closeChat: () => {
                const modal = document.getElementById('chat-modal');
                const backdrop = document.getElementById('chat-backdrop');
                
                // Animation out
                modal.style.transform = 'translateY(100%)';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    backdrop.classList.add('hidden');
                    document.body.style.overflow = '';
                    if (state.chatUnsubscribe) state.chatUnsubscribe();
                    state.currentChatId = null;
                }, 300);
            },

            loadChatMessages: (matchId) => {
                const { collection, query, orderBy, onSnapshot } = window.firebaseMethods;
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = '<div class="text-center py-10 text-gray-600 text-xs uppercase tracking-widest"><div class="loader w-6 h-6 border-2"></div></div>';

                const collName = `chat_${matchId}`;
                const q = query(
                    collection(window.firebaseDB, 'artifacts', APP_ID, 'public', 'data', collName),
                    orderBy('timestamp', 'asc')
                );

                state.chatUnsubscribe = onSnapshot(q, (snapshot) => {
                    const messages = [];
                    snapshot.forEach((doc) => messages.push({ id: doc.id, ...doc.data() }));
                    app.renderMessages(messages);
                }, (error) => {
                    console.error("Error loading chat:", error);
                    messagesContainer.innerHTML = '<div class="text-center py-10 text-gray-600 text-xs">Error al cargar chat</div>';
                });
            },

            renderMessages: (messages) => {
                const container = document.getElementById('chat-messages');
                const myName = localStorage.getItem('rf_username');
                
                if (messages.length === 0) {
                    container.innerHTML = '<div class="text-center py-20 text-gray-600 text-xs uppercase tracking-widest opacity-50">Sé el primero en comentar</div>';
                    return;
                }

                container.innerHTML = messages.map(msg => {
                    const isMe = msg.user === myName;
                    const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    return `
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-fade-in">
                            <div class="chat-bubble ${isMe ? 'chat-own' : 'chat-other'}">
                                ${!isMe ? `<div class="chat-name">${msg.user}</div>` : ''}
                                ${msg.text}
                                <div class="chat-time text-xs ${isMe ? 'text-gray-400' : 'text-gray-500'}">${time}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.scrollTop = container.scrollHeight;
            },

            sendMessage: async (e) => {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const btn = document.getElementById('chat-send-btn');
                const text = input.value.trim();
                
                if (!text || !state.currentChatId || !state.user) return;

                const name = localStorage.getItem('rf_username');
                const matchId = state.currentChatId;

                input.disabled = true;
                btn.disabled = true;
                btn.innerHTML = '<div class="loader w-4 h-4 border-2"></div>';

                const { addDoc, collection, serverTimestamp, doc, setDoc, increment, updateDoc } = window.firebaseMethods;
                const collName = `chat_${matchId}`;

                try {
                    await addDoc(collection(window.firebaseDB, 'artifacts', APP_ID, 'public', 'data', collName), {
                        text: text,
                        user: name,
                        userId: state.user.uid,
                        timestamp: serverTimestamp()
                    });

                    // Update count safely
                    const countRef = doc(window.firebaseDB, 'artifacts', APP_ID, 'public', 'data', 'chat_counts', matchId.toString());
                    try {
                        await updateDoc(countRef, { count: increment(1) });
                    } catch (err) {
                        await setDoc(countRef, { count: 1 });
                    }

                    input.value = '';
                    input.focus();
                } catch (error) {
                    console.error("Error sending message:", error);
                    alert("Error enviando mensaje. Revisa tu conexión.");
                } finally {
                    input.disabled = false;
                    btn.disabled = false;
                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transform rotate-90 ml-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>';
                }
            },

            changeDate: (days) => { state.date.setDate(state.date.getDate() + days); app.renderCalendar(); app.loadMatches(); },
            resetDate: () => { state.date = new Date(); app.renderCalendar(); app.loadMatches(); },
            renderCalendar: () => {
                const container = document.getElementById('calendar-days');
                const month = document.getElementById('current-month');
                const todayTxt = document.getElementById('current-day-text');
                const months = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
                month.innerText = months[state.date.getMonth()];
                const isToday = state.date.toDateString() === new Date().toDateString();
                todayTxt.innerText = isToday ? "HOY" : state.date.toLocaleDateString('es-AR', {day:'numeric', month:'short'}).toUpperCase();
                container.innerHTML = '';
                const start = new Date(state.date); start.setDate(start.getDate() - 3);
                for(let i=0; i<7; i++){
                    const d = new Date(start); d.setDate(d.getDate() + i);
                    const isSel = d.toDateString() === state.date.toDateString();
                    const div = document.createElement('div');
                    div.className = `flex flex-col items-center justify-center w-10 h-14 rounded cursor-pointer transition-all ${isSel ? 'bg-white text-black font-bold' : 'hover:bg-[#222] text-gray-500'}`;
                    div.innerHTML = `<span class="text-[9px] font-bold uppercase tracking-widest">${getDayName(d)}</span><span class="text-sm font-bold">${d.getDate()}</span>`;
                    div.onclick = () => { state.date = d; app.renderCalendar(); app.loadMatches(); };
                    container.appendChild(div);
                }
            },

            loadMatches: async (silent=false) => {
                if(!silent) document.getElementById('view-match-list').innerHTML = `<div class="flex justify-center py-20"><div class="loader"></div></div>`;
                const dateStr = formatDate(state.date);
                const targetIds = [128, 1032, 129, 39, 140, 78, 71, 13, 11]; 
                try {
                    const data = await fetchAPI(`/fixtures?date=${dateStr}&timezone=America/Argentina/Buenos_Aires`);
                    let matches = data.response.filter(m => targetIds.includes(m.league.id));
                    matches.sort((a,b) => {
                        const isArgA = [128,1032].includes(a.league.id);
                        const isArgB = [128,1032].includes(b.league.id);
                        if(isArgA && !isArgB) return -1;
                        if(!isArgA && isArgB) return 1;
                        return a.fixture.timestamp - b.fixture.timestamp;
                    });
                    state.matches = matches;
                    app.renderMatches();
                    app.updateBadges();
                } catch(e) {
                    document.getElementById('view-match-list').innerHTML = `<div class="text-center py-10 text-gray-500"><p>Error de conexión o límite diario alcanzado.</p></div>`;
                }
            },

            renderMatches: () => {
                const container = document.getElementById('view-match-list');
                let list = state.matches;
                if(state.liveOnly) list = list.filter(m => ['1H','HT','2H','ET','P','LIVE'].includes(m.fixture.status.short));
                if(list.length === 0) {
                    container.innerHTML = `<div class="text-center py-20 text-gray-600 uppercase tracking-widest text-xs"><p>${state.liveOnly ? 'No hay partidos en vivo' : 'No hay partidos destacados'}</p></div>`;
                    return;
                }
                const groups = {};
                list.forEach(m => {
                    if(!groups[m.league.id]) groups[m.league.id] = { name: m.league.name, logo: m.league.logo, matches: [] };
                    groups[m.league.id].matches.push(m);
                });
                let html = '';
                Object.values(groups).forEach(g => {
                    html += `<div class="mb-6"><div class="px-2 py-2 flex items-center gap-3"><img src="${g.logo}" class="w-4 h-4 object-contain"><h3 class="text-xs font-bold text-white uppercase tracking-widest">${g.name}</h3></div><div class="space-y-2">`;
                    g.matches.forEach(m => {
                        const s = m.fixture.status;
                        const isLive = ['1H','2H','ET','P','LIVE'].includes(s.short);
                        const isHT = s.short === 'HT';
                        const isFin = ['FT','AET','PEN'].includes(s.short);
                        const notStarted = ['NS','TBD'].includes(s.short);
                        const timeDisplay = isLive ? `<span class="text-white font-bold animate-pulse text-xs">${s.elapsed}'</span>` : (isHT ? '<span class="text-white font-bold text-xs">ET</span>' : (isFin ? 'FINAL' : new Date(m.fixture.date).toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'})));
                        let homeOpacity = 'opacity-100', awayOpacity = 'opacity-100';
                        if (!notStarted) {
                            if ((m.goals.home ?? 0) > (m.goals.away ?? 0)) awayOpacity = 'opacity-50';
                            else if ((m.goals.away ?? 0) > (m.goals.home ?? 0)) homeOpacity = 'opacity-50';
                        }
                        let hScorers = '', aScorers = '';
                        if (m.events && m.events.length > 0) {
                            const goals = m.events.filter(e => e.type === 'Goal');
                            if (goals.length > 0) {
                                const formatScorer = (ev) => `${ev.player.name} ${ev.time.elapsed}'`;
                                const hGoals = goals.filter(e => e.team.id === m.teams.home.id).map(formatScorer);
                                const aGoals = goals.filter(e => e.team.id === m.teams.away.id).map(formatScorer);
                                if (hGoals.length > 0) hScorers = hGoals.join(', ');
                                if (aGoals.length > 0) aScorers = aGoals.join(', ');
                            }
                        }
                        const chatCount = state.chatCounts[m.fixture.id] || 0;
                        const badgeClass = chatCount > 0 ? '' : 'hidden';

                        html += `
                        <div class="p-4 match-card relative bg-[#0a0a0a] rounded flex flex-col gap-3">
                            <div class="flex items-center justify-between clickable" onclick="app.openDetail(${m.fixture.id})">
                                ${isLive ? '<div class="absolute top-3 right-3"><div class="live-dot"></div></div>' : ''}
                                <div class="flex-1 flex justify-end items-center gap-3 ${homeOpacity} transition-opacity duration-300 text-right">
                                    <div class="flex flex-col items-end"><span class="font-bold text-white text-sm uppercase tracking-tight leading-none">${m.teams.home.name}</span>${hScorers ? `<span class="text-[9px] text-gray-500 font-mono mt-1">${hScorers}</span>` : ''}</div>
                                    <img src="${m.teams.home.logo}" class="w-8 h-8 object-contain">
                                </div>
                                <div class="px-3 flex flex-col items-center w-24 shrink-0">
                                    ${notStarted ? `<span class="text-xl font-bold text-gray-600 score-font tracking-tighter">${timeDisplay}</span>` : `<div class="flex gap-2 text-2xl font-black text-white score-font tracking-widest"><span class="${homeOpacity}">${m.goals.home ?? 0}</span><span class="text-gray-700">-</span><span class="${awayOpacity}">${m.goals.away ?? 0}</span></div>`}
                                    <span class="text-[9px] font-bold uppercase text-gray-500 mt-1 tracking-widest">${isLive || isHT || isFin ? timeDisplay : ''}</span>
                                </div>
                                <div class="flex-1 flex justify-start items-center gap-3 ${awayOpacity} transition-opacity duration-300 text-left">
                                    <img src="${m.teams.away.logo}" class="w-8 h-8 object-contain">
                                    <div class="flex flex-col items-start"><span class="font-bold text-white text-sm uppercase tracking-tight leading-none">${m.teams.away.name}</span>${aScorers ? `<span class="text-[9px] text-gray-500 font-mono mt-1">${aScorers}</span>` : ''}</div>
                                </div>
                            </div>
                             <div class="border-t border-[#222] pt-2 mt-1 flex justify-center">
                                <button onclick="app.openChat(event, ${m.fixture.id}, '${m.teams.home.name.replace(/'/g, "\\'")}', '${m.teams.away.name.replace(/'/g, "\\'")}')" class="flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-white transition-colors py-1 px-3 rounded hover:bg-[#222]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" /></svg>
                                    FORO
                                    <span class="bg-white text-black text-[10px] px-1.5 rounded-sm font-black chat-badge ${badgeClass}" data-match-id="${m.fixture.id}">${chatCount}</span>
                                </button>
                            </div>
                        </div>`;
                    });
                    html += `</div></div>`;
                });
                container.innerHTML = html;
                app.updateBadges();
            },

            openDetail: async (id) => {
                const m = state.matches.find(x => x.fixture.id == id);
                if(!m) return;
                state.selectedMatch = m;
                document.getElementById('view-match-detail').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                document.getElementById('detail-content-wrapper').classList.add('hidden');
                document.getElementById('detail-loader').classList.remove('hidden');
                document.getElementById('detail-home-name').innerText = m.teams.home.name;
                document.getElementById('detail-away-name').innerText = m.teams.away.name;
                document.getElementById('detail-home-logo').src = m.teams.home.logo;
                document.getElementById('detail-away-logo').src = m.teams.away.logo;
                document.getElementById('detail-home-score').innerText = m.goals.home ?? 0;
                document.getElementById('detail-away-score').innerText = m.goals.away ?? 0;
                document.getElementById('detail-status').innerText = m.fixture.status.long;
                try {
                    const data = await fetchAPI(`/fixtures?id=${id}`);
                    const fullMatch = data.response[0];
                    app.renderTimeline(fullMatch);
                    app.renderLineups(fullMatch);
                    app.renderStats(fullMatch);
                } catch(e) { console.error(e); }
                document.getElementById('detail-loader').classList.add('hidden');
                document.getElementById('detail-content-wrapper').classList.remove('hidden');
            },

            closeDetail: () => {
                document.getElementById('view-match-detail').classList.add('hidden');
                document.body.style.overflow = '';
            },

            renderTimeline: (m) => {
                const c = document.getElementById('tab-timeline');
                const ev = m.events || [];
                if(ev.length === 0) { c.innerHTML = '<div class="text-center py-10 text-gray-600 text-xs uppercase tracking-widest">Sin eventos</div>'; return; }
                c.innerHTML = ev.map(e => `
                    <div class="flex items-center gap-4 mb-4 ${e.team.id === m.teams.home.id ? 'flex-row' : 'flex-row-reverse'}">
                        <div class="w-8 text-center text-xs font-bold text-gray-500 font-mono">${e.time.elapsed}'</div>
                        <div class="bg-[#111] border border-[#222] px-4 py-3 flex items-center gap-3 ${e.team.id === m.teams.home.id ? '' : 'flex-row-reverse text-right'} min-w-[140px]">
                            <span class="text-sm font-bold text-white">${e.player.name}</span>
                            <span class="text-[9px] px-2 py-0.5 uppercase font-bold tracking-wider ${e.type === 'Goal' ? 'bg-white text-black' : 'bg-[#333] text-gray-400'}">${e.type === 'Goal' ? 'GOL' : e.detail}</span>
                        </div>
                    </div>`).join('');
            },

            renderLineups: (m) => {
                const pitch = document.getElementById('football-pitch');
                pitch.querySelectorAll('.player-marker').forEach(el => el.remove());
                const hList = document.getElementById('lineup-home-list');
                const aList = document.getElementById('lineup-away-list');
                if(!m.lineups || m.lineups.length === 0) { hList.innerHTML = 'No disponible'; aList.innerHTML = 'No disponible'; return; }
                const homeL = m.lineups[0]; const awayL = m.lineups[1];
                hList.innerHTML = homeL.startXI.map(p => `<div class="flex justify-between border-b border-[#222] py-1.5"><span class="text-gray-300">${p.player.name}</span><span class="text-gray-600 font-mono text-xs">${p.player.number}</span></div>`).join('');
                aList.innerHTML = awayL.startXI.map(p => `<div class="flex justify-between border-b border-[#222] py-1.5"><span class="text-gray-600 font-mono text-xs">${p.player.number}</span><span class="text-gray-300">${p.player.name}</span></div>`).join('');
                const addPlayers = (players, side) => {
                    players.forEach((p, i) => {
                        const el = document.createElement('div');
                        el.className = `player-marker ${side === 'home' ? 'home-player' : 'away-player'}`;
                        el.innerText = p.player.number;
                        let x = 50, y = 50;
                        if(p.player.grid) {
                            const parts = p.player.grid.split(':');
                            const col = parseInt(parts[0]); const row = parseInt(parts[1]); 
                            if(side === 'home') x = (col * 18); else x = 100 - (col * 18);
                            y = (row * 20) + 10;
                        } else {
                            if(side === 'home') x = 10 + (i%4)*20; else x = 90 - (i%4)*20;
                            y = 10 + (i%3)*30;
                        }
                        el.style.left = x + '%'; el.style.top = y + '%';
                        el.onclick = () => { document.getElementById('modal-player-name').innerText = p.player.name; document.getElementById('player-modal').classList.remove('hidden'); };
                        pitch.appendChild(el);
                    });
                };
                addPlayers(homeL.startXI, 'home'); addPlayers(awayL.startXI, 'away');
            },

            renderStats: (m) => {
                const c = document.getElementById('tab-stats');
                if(!m.statistics || m.statistics.length === 0) { c.innerHTML = 'No disponible'; return; }
                const statsTypes = ['Ball Possession', 'Total Shots', 'Shots on Goal', 'Corner Kicks', 'Fouls', 'Yellow Cards', 'Red Cards'];
                const hStats = m.statistics[0].statistics; const aStats = m.statistics[1].statistics;
                c.innerHTML = statsTypes.map(type => {
                    const hVal = hStats.find(s=>s.type===type)?.value || 0;
                    const aVal = aStats.find(s=>s.type===type)?.value || 0;
                    const hNum = parseInt(hVal); const aNum = parseInt(aVal);
                    const total = hNum + aNum || 1;
                    const hPerc = (hNum / total) * 100;
                    return `<div class="bg-[#111] p-4 border border-[#222]"><div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase mb-3 tracking-widest"><span>${hVal}</span><span>${type.replace('Ball Possession','Posesión').replace('Shots','Tiros')}</span><span>${aVal}</span></div><div class="h-1 bg-[#333] flex overflow-hidden"><div class="h-full bg-white" style="width: ${hPerc}%"></div><div class="h-full bg-[#555]" style="width: ${100-hPerc}%"></div></div></div>`;
                }).join('');
            },

            changeSeason: (y) => { state.season = y; if(state.selectedLeague) app.showStandings(state.selectedLeague.id, state.selectedLeague.name); },
            showStandings: async (id, name) => {
                state.selectedLeague = {id, name};
                document.getElementById('view-match-list').classList.add('hidden');
                document.getElementById('date-nav').classList.add('hidden');
                document.getElementById('view-standings').classList.remove('hidden');
                document.getElementById('standings-title').innerText = name;
                document.getElementById('standings-tabs').classList.add('hidden');
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-backdrop').classList.add('hidden');
                const container = document.getElementById('standings-container');
                container.innerHTML = `<div class="flex justify-center py-20"><div class="loader"></div></div>`;
                try {
                    const data = await fetchAPI(`/standings?league=${id}&season=${state.season}`);
                    const standings = data.response[0].league.standings;
                    app.processStandings(standings);
                } catch(e) { container.innerHTML = `<div class="text-center text-gray-500 py-10 text-xs uppercase tracking-widest">Sin datos para ${state.season}.</div>`; }
            },
            processStandings: (standingsData) => {
                const tabs = document.getElementById('standings-tabs');
                if(standingsData.length > 1) {
                    tabs.classList.remove('hidden');
                    tabs.innerHTML = standingsData.map((g, i) => `<button onclick="app.renderTable(${i})" class="px-4 py-2 bg-[#111] text-xs font-bold uppercase border border-[#333] text-gray-400 hover:text-white hover:border-white transition-all whitespace-nowrap">${g[0].group}</button>`).join('');
                    state.standingsData = standingsData; app.renderTable(0);
                } else {
                    tabs.classList.add('hidden'); state.standingsData = standingsData; app.renderTable(0);
                }
            },
            renderTable: (groupIndex) => {
                const table = state.standingsData[groupIndex];
                const container = document.getElementById('standings-container');
                container.innerHTML = `<div class="bg-[#0a0a0a] border border-[#222] overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-400"><thead class="text-[10px] text-gray-500 uppercase bg-[#111] border-b border-[#222] tracking-widest"><tr><th class="px-4 py-3 text-center w-10">#</th><th class="px-3 py-3">Equipo</th><th class="px-2 py-3 text-center text-white">Pts</th><th class="px-2 py-3 text-center">PJ</th><th class="px-2 py-3 text-center font-mono">DG</th><th class="px-2 py-3 text-center hidden sm:table-cell">Forma</th></tr></thead><tbody class="divide-y divide-[#1a1a1a]">${table.map(t => `<tr class="hover:bg-[#111] transition-colors"><td class="px-4 py-3 text-center font-bold ${t.rank<=4?'text-white':'text-gray-600'}">${t.rank}</td><td class="px-3 py-3 font-bold text-gray-300 flex items-center gap-3 whitespace-nowrap uppercase text-xs"><img src="${t.team.logo}" class="w-5 h-5 object-contain">${t.team.name}</td><td class="px-2 py-3 text-center font-bold text-white">${t.points}</td><td class="px-2 py-3 text-center font-mono text-xs">${t.all.played}</td><td class="px-2 py-3 text-center font-mono text-xs ${t.goalsDiff > 0 ? 'text-white' : 'text-gray-600'}">${t.goalsDiff>0?'+':''}${t.goalsDiff}</td><td class="px-2 py-3 text-center hidden sm:table-cell"><div class="flex justify-center gap-0.5">${t.form ? t.form.split('').slice(-5).map(f => `<div class="w-1.5 h-1.5 rounded-full ${f==='W'?'bg-white':(f==='D'?'bg-gray-500':'bg-[#333]')}\"></div>`).join('') : '-'}</div></td></tr>`).join('')}</tbody></table></div></div>`;
            },
            navigateToMatches: () => {
                document.getElementById('view-standings').classList.add('hidden');
                document.getElementById('view-match-list').classList.remove('hidden');
                document.getElementById('date-nav').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-backdrop').classList.add('hidden');
            }
        };

        app.init();
    </script>
</body>
</html>
