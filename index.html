<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RealFutbol App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #000000;
            --bg-card: #0f0f0f;
            --border: #333333;
            --text-main: #ffffff;
            --text-muted: #888888;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main);
            color: var(--text-main);
            overscroll-behavior-y: none; /* Evita rebote en iOS */
            -webkit-tap-highlight-color: transparent;
        }

        .font-sport { font-family: 'Chakra Petch', sans-serif; }
        
        .match-card { 
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        
        /* FIX MOBILE CLICK: Cursor pointer fuerza a iOS a reconocer el evento click */
        .match-card.clickable { cursor: pointer; }
        .match-card.clickable:active { background-color: #1a1a1a; border-color: #666; }
        
        .match-card.not-clickable { opacity: 1; cursor: default; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

        .football-pitch { 
            background-color: #151515;
            border: 2px solid #444; 
            position: relative; width: 100%; aspect-ratio: 7 / 5; 
            border-radius: 4px; overflow: hidden; 
        }
        .center-line { top: 0; bottom: 0; left: 50%; width: 1px; background: #444; position: absolute; transform: translateX(-50%); }
        .center-circle { top: 50%; left: 50%; width: 20%; height: 28%; border: 1px solid #444; border-radius: 50%; position: absolute; transform: translate(-50%, -50%); }
        .penalty-box { position: absolute; border: 1px solid #444; width: 15%; height: 40%; top: 30%; }
        .home-box { left: 0; border-left: none; }
        .away-box { right: 0; border-right: none; }
        
        .player-marker { 
            position: absolute; width: 26px; height: 26px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 800; font-size: 10px; 
            z-index: 10; cursor: pointer; border: 1px solid #000;
        }
        .home-player { background-color: #ffffff; color: #000000; }
        .away-player { background-color: #333333; color: #ffffff; border: 1px solid #fff; }

        .loader { width: 32px; height: 32px; border: 3px solid #333; border-bottom-color: #fff; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-float-back {
            position: fixed; top: 16px; left: 16px; z-index: 100;
            background: #000; border: 1px solid #444; color: white;
            padding: 10px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .live-dot { height: 6px; width: 6px; background-color: #fff; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.4; transform: scale(0.8); } }

        .mobile-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 45; backdrop-filter: blur(4px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estado Offline/Demo */
        .demo-badge { position: fixed; bottom: 10px; right: 10px; background: #333; color: #aaa; font-size: 9px; padding: 2px 6px; border-radius: 4px; z-index: 100; pointer-events: none; opacity: 0.7; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden w-full bg-black text-white">

    <div id="demo-indicator" class="demo-badge hidden">MODO DEMO (OFFLINE/CORS)</div>

    <!-- HEADER -->
    <header class="h-14 border-b border-[#222] bg-black flex items-center justify-between px-4 z-40 shrink-0 relative w-full">
        <div class="flex items-center w-12">
            <button id="mobile-menu-btn" class="text-white p-2 -ml-2 rounded active:bg-[#222]">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
        </div>
        <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center justify-center cursor-pointer" onclick="window.location.reload()">
            <img src="https://i.postimg.cc/pL6B4Mpr/real-futbol-removebg-preview.png" alt="Real Futbol Logo" class="h-14 object-contain ml-10">
        </div>
        <div class="flex items-center justify-end w-12">
            <!-- Toggle simple para ahorrar espacio -->
            <button onclick="app.toggleLive()" id="btn-live" class="text-[10px] font-bold border border-[#333] rounded px-2 py-1 text-gray-500">LIVE</button>
        </div>
    </header>

    <!-- MENU LATERAL -->
    <div id="mobile-backdrop" class="mobile-backdrop hidden lg:hidden"></div>
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-[280px] bg-black border-r border-[#222] flex flex-col transform -translate-x-full lg:translate-x-0 lg:static lg:w-72 transition-transform duration-300 z-50 h-full shadow-2xl">
        <div class="p-5 border-b border-[#222] flex justify-between items-center lg:hidden">
            <h2 class="font-bold text-white text-lg uppercase tracking-widest font-sport">Menu</h2>
            <button id="close-sidebar" class="text-white p-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
        </div>
        <div class="overflow-y-auto flex-1 p-3 space-y-1">
            <div class="px-3 py-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Torneos</div>
            <button onclick="app.showStandings(128, 'Liga Profesional')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 active:bg-[#1a1a1a] transition-all"><img src="https://media.api-sports.io/football/leagues/128.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">Liga Argentina</span></button>
            <button onclick="app.showStandings(1032, 'Copa de la Liga')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 active:bg-[#1a1a1a] transition-all"><img src="https://media.api-sports.io/football/leagues/1032.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">Copa LPF</span></button>
            <button onclick="app.showStandings(140, 'La Liga')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 active:bg-[#1a1a1a] transition-all"><img src="https://media.api-sports.io/football/leagues/140.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">La Liga</span></button>
            <button onclick="app.showStandings(39, 'Premier League')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-300 active:bg-[#1a1a1a] transition-all"><img src="https://media.api-sports.io/football/leagues/39.png" class="w-5 h-5 object-contain"><span class="text-sm font-bold">Premier League</span></button>
            <div class="mt-8 px-2">
                <button onclick="app.navigateToMatches()" class="w-full bg-white text-black font-bold py-3 px-4 text-xs uppercase tracking-widest border border-white active:bg-gray-300 transition-colors">Partidos de Hoy</button>
            </div>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 flex flex-col relative w-full overflow-hidden bg-black">
        <!-- Navegación Fechas -->
        <div id="date-nav" class="border-b border-[#222] p-3 z-10 sticky top-0 bg-black/95 backdrop-blur shrink-0">
            <div class="flex items-center justify-between mb-3 max-w-lg mx-auto">
                <button onclick="app.changeDate(-1)" class="p-2 text-gray-400 active:text-white rounded"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                <div class="text-center cursor-pointer active:scale-95 transition-transform" onclick="app.resetDate()">
                    <h2 id="current-month" class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-0.5">MES</h2>
                    <div id="current-day-text" class="text-lg font-bold text-white leading-none font-sport">HOY</div>
                </div>
                <button onclick="app.changeDate(1)" class="p-2 text-gray-400 active:text-white rounded"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
            </div>
            <div id="calendar-days" class="flex justify-between max-w-lg mx-auto gap-1"></div>
        </div>

        <div id="main-content" class="flex-1 overflow-y-auto p-4 relative scroll-smooth pb-32">
            <!-- Lista Partidos -->
            <div id="view-match-list" class="max-w-3xl mx-auto space-y-6 animate-fade-in"></div>

            <!-- Tabla Posiciones -->
            <div id="view-standings" class="hidden max-w-4xl mx-auto animate-fade-in">
                <div class="flex flex-col gap-4 mb-6 sticky top-0 z-20 bg-black/95 backdrop-blur py-2 border-b border-[#222]">
                    <div class="flex items-center justify-between px-1">
                        <div class="flex items-center gap-3">
                            <button onclick="app.navigateToMatches()" class="lg:hidden p-1 text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg></button>
                            <h2 id="standings-title" class="text-xl font-bold text-white uppercase tracking-wider font-sport">Tabla</h2>
                        </div>
                        <select id="season-selector" onchange="app.changeSeason(this.value)" class="bg-[#111] text-white text-sm border border-[#333] p-1 px-2 rounded focus:outline-none font-mono">
                            <option value="2025">2025</option>
                            <option value="2024" selected>2024</option>
                        </select>
                    </div>
                    <div id="standings-tabs" class="flex overflow-x-auto gap-2 px-1 no-scrollbar hidden"></div>
                </div>
                <div id="standings-container" class="space-y-6"></div>
            </div>

            <!-- Detalle Partido -->
            <div id="view-match-detail" class="hidden fixed inset-0 bg-black z-[60] overflow-y-auto animate-fade-in h-[100dvh]">
                <div class="max-w-4xl mx-auto min-h-full bg-[#050505] relative pb-20">
                    <button onclick="app.closeDetail()" class="btn-float-back active:bg-[#222] transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    </button>
                    <div id="detail-loader" class="hidden py-40 text-center"><div class="loader"></div></div>
                    <div id="detail-content-wrapper" class="pt-16 pb-20">
                        <div class="relative p-6 text-center border-b border-[#222] bg-[#0a0a0a]">
                            <div class="flex justify-between items-center max-w-md mx-auto">
                                <div class="flex-1 flex flex-col items-center gap-3"><img id="detail-home-logo" src="" class="w-16 h-16 object-contain"><h3 id="detail-home-name" class="font-bold text-sm leading-tight text-white uppercase">Home</h3></div>
                                <div class="px-4 flex flex-col items-center">
                                    <div class="text-4xl font-black text-white tracking-tighter flex items-center gap-2 score-font"><span id="detail-home-score">-</span><span class="text-gray-600 text-2xl">:</span><span id="detail-away-score">-</span></div>
                                    <div id="detail-status" class="mt-2 text-[10px] font-bold text-gray-500 uppercase tracking-widest">VS</div>
                                </div>
                                <div class="flex-1 flex flex-col items-center gap-3"><img id="detail-away-logo" src="" class="w-16 h-16 object-contain"><h3 id="detail-away-name" class="font-bold text-sm leading-tight text-white uppercase">Away</h3></div>
                            </div>
                        </div>
                        <div class="flex border-b border-[#222] sticky top-0 bg-black/95 backdrop-blur z-30 overflow-x-auto no-scrollbar">
                            <button class="flex-1 py-3 px-4 text-xs font-bold text-white border-b-2 border-white tab-btn whitespace-nowrap uppercase" onclick="app.switchTab(event, 'tab-timeline')">Timeline</button>
                            <button class="flex-1 py-3 px-4 text-xs font-bold text-gray-500 tab-btn whitespace-nowrap uppercase" onclick="app.switchTab(event, 'tab-lineups')">Alineaciones</button>
                            <button class="flex-1 py-3 px-4 text-xs font-bold text-gray-500 tab-btn whitespace-nowrap uppercase" onclick="app.switchTab(event, 'tab-stats')">Stats</button>
                        </div>
                        <div class="p-4 lg:p-8 space-y-6 min-h-[50vh]">
                            <div id="tab-timeline" class="tab-content block space-y-4 max-w-2xl mx-auto"></div>
                            <div id="tab-lineups" class="tab-content hidden max-w-2xl mx-auto">
                                <div class="football-pitch mx-auto" id="football-pitch"><div class="center-line"></div><div class="center-circle"></div><div class="penalty-box home-box"></div><div class="penalty-box away-box"></div></div>
                                <div class="grid grid-cols-2 gap-4 mt-6">
                                    <div class="bg-[#111] p-4 rounded border border-[#222]"><h4 class="text-white font-bold border-b border-[#333] pb-2 mb-2 text-xs uppercase tracking-wider">Local</h4><div id="lineup-home-list" class="space-y-2 text-xs text-gray-400 font-mono"></div></div>
                                    <div class="bg-[#111] p-4 rounded border border-[#222]"><h4 class="text-white font-bold border-b border-[#333] pb-2 mb-2 text-right text-xs uppercase tracking-wider">Visitante</h4><div id="lineup-away-list" class="space-y-2 text-xs text-gray-400 text-right font-mono"></div></div>
                                </div>
                            </div>
                            <div id="tab-stats" class="tab-content hidden space-y-4 max-w-xl mx-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // --- CONFIGURACIÓN A PRUEBA DE FALLOS ---
        const API_KEY = "1d6013be5112e78ac0ee1c138fbad117";
        const API_BASE = "https://v3.football.api-sports.io";
        
        // Función Ultra-Robusta: Si falla la API por CORS/Mobile, usa Mock Data inmediatamente
        const fetchAPI = async (endpoint) => {
            const cacheKey = "bw_robust_" + endpoint;
            const cached = localStorage.getItem(cacheKey);
            if(cached){
                const {ts, data} = JSON.parse(cached);
                if(Date.now() - ts < 600000) return data; // 10 min cache
            }
            
            try {
                // Intento Real
                const res = await fetch(`${API_BASE}${endpoint}`, { 
                    headers: { "x-apisports-key": API_KEY }
                });
                
                if(!res.ok) throw new Error("HTTP Error");
                
                const data = await res.json();
                
                if(data.errors && Object.keys(data.errors).length > 0) {
                    console.warn("API Error (Quota/Limit):", data.errors);
                    throw new Error("API Logic Error");
                }
                
                document.getElementById('demo-indicator').classList.add('hidden');
                localStorage.setItem(cacheKey, JSON.stringify({ts: Date.now(), data}));
                return data;

            } catch(e) {
                // FALLBACK AUTOMÁTICO - Si falla (CORS en celular), usa Mock Data
                console.log("Modo Fallback activado:", e);
                document.getElementById('demo-indicator').classList.remove('hidden');
                
                // Simular retardo de red para realismo
                await new Promise(r => setTimeout(r, 500)); 

                if(endpoint.includes('fixtures')) return getMockMatches();
                if(endpoint.includes('standings')) return getMockStandings();
                
                return { response: [] };
            }
        };

        // --- MOCK DATA ROBUSTA (Para cuando falle la API en celular) ---
        const getMockMatches = () => ({
            response: [
                { 
                    fixture: { id: 101, date: new Date().toISOString(), status: { short: 'LIVE', elapsed: 72, long: 'En Vivo' }, timestamp: Date.now() }, 
                    league: { id: 128, name: 'Liga Profesional', logo: 'https://media.api-sports.io/football/leagues/128.png' }, 
                    teams: { home: { id: 1, name: 'Boca Juniors', logo: 'https://media.api-sports.io/football/teams/451.png' }, away: { id: 2, name: 'River Plate', logo: 'https://media.api-sports.io/football/teams/435.png' } }, 
                    goals: { home: 2, away: 1 }, 
                    events: [ { type: 'Goal', time: { elapsed: 15 }, team: { id: 1 }, player: { name: 'E. Cavani' }, detail: 'Normal Goal' }, { type: 'Goal', time: { elapsed: 40 }, team: { id: 2 }, player: { name: 'M. Borja' }, detail: 'Normal Goal' }, { type: 'Goal', time: { elapsed: 68 }, team: { id: 1 }, player: { name: 'M. Merentiel' }, detail: 'Normal Goal' } ],
                    lineups: [
                        { startXI: [{player:{name:'S. Romero', number:1}}, {player:{name:'L. Advincula', number:17}}, {player:{name:'M. Rojo', number:6}}, {player:{name:'N. Figal', number:4}}, {player:{name:'F. Fabra', number:18}}, {player:{name:'E. Fernandez', number:21}}, {player:{name:'G. Pol Fernandez', number:8}}, {player:{name:'K. Zenon', number:22}}, {player:{name:'C. Medina', number:36}}, {player:{name:'E. Cavani', number:10}}, {player:{name:'M. Merentiel', number:16}}] },
                        { startXI: [{player:{name:'F. Armani', number:1}}, {player:{name:'A. Herrera', number:15}}, {player:{name:'L. Gonzalez Pirez', number:14}}, {player:{name:'P. Diaz', number:17}}, {player:{name:'E. Diaz', number:13}}, {player:{name:'R. Villagra', number:23}}, {player:{name:'R. Aliendro', number:29}}, {player:{name:'I. Fernandez', number:26}}, {player:{name:'C. Echeverri', number:19}}, {player:{name:'P. Solari', number:36}}, {player:{name:'M. Borja', number:9}}] }
                    ],
                    statistics: [ { statistics: [{type:'Ball Possession', value:'45%'}, {type:'Total Shots', value:12}, {type:'Fouls', value:14}] }, { statistics: [{type:'Ball Possession', value:'55%'}, {type:'Total Shots', value:10}, {type:'Fouls', value:11}] } ]
                },
                { 
                    fixture: { id: 102, date: new Date().toISOString(), status: { short: 'FT', elapsed: 90, long: 'Finalizado' }, timestamp: Date.now() - 3600000 }, 
                    league: { id: 140, name: 'La Liga', logo: 'https://media.api-sports.io/football/leagues/140.png' }, 
                    teams: { home: { id: 3, name: 'Real Madrid', logo: 'https://media.api-sports.io/football/teams/541.png' }, away: { id: 4, name: 'Barcelona', logo: 'https://media.api-sports.io/football/teams/529.png' } }, 
                    goals: { home: 3, away: 2 },
                    events: [], lineups: [], statistics: []
                },
                { 
                    fixture: { id: 103, date: new Date().toISOString(), status: { short: 'NS', elapsed: 0, long: 'Por Jugar' }, timestamp: Date.now() + 7200000 }, 
                    league: { id: 39, name: 'Premier League', logo: 'https://media.api-sports.io/football/leagues/39.png' }, 
                    teams: { home: { id: 5, name: 'Man City', logo: 'https://media.api-sports.io/football/teams/50.png' }, away: { id: 6, name: 'Arsenal', logo: 'https://media.api-sports.io/football/teams/42.png' } }, 
                    goals: { home: null, away: null },
                    events: [], lineups: [], statistics: []
                }
            ]
        });

        const getMockStandings = () => ({
            response: [{
                league: {
                    standings: [[
                        { rank: 1, team: { name: "Boca Juniors", logo: "https://media.api-sports.io/football/teams/451.png" }, points: 15, goalsDiff: 8, all: { played: 5 }, form: "WWWDW" },
                        { rank: 2, team: { name: "River Plate", logo: "https://media.api-sports.io/football/teams/435.png" }, points: 13, goalsDiff: 6, all: { played: 5 }, form: "WDWWW" },
                        { rank: 3, team: { name: "Racing Club", logo: "https://media.api-sports.io/football/teams/436.png" }, points: 10, goalsDiff: 4, all: { played: 5 }, form: "LWWDW" },
                        { rank: 4, team: { name: "Independiente", logo: "https://media.api-sports.io/football/teams/438.png" }, points: 9, goalsDiff: 1, all: { played: 5 }, form: "DLLWW" },
                        { rank: 5, team: { name: "San Lorenzo", logo: "https://media.api-sports.io/football/teams/442.png" }, points: 8, goalsDiff: 0, all: { played: 5 }, form: "DDDDW" },
                        { rank: 6, team: { name: "Talleres", logo: "https://media.api-sports.io/football/teams/441.png" }, points: 7, goalsDiff: -2, all: { played: 5 }, form: "LLWWD" },
                    ]]
                }
            }]
        });

        // --- LÓGICA DE LA APP ---
        const state = { date: new Date(), matches: [], liveOnly: false, selectedLeague: null, season: 2024, standingsData: null };
        const formatDate = (d) => d.toISOString().split('T')[0];
        const getDayName = (d) => d.toLocaleDateString('es-AR', {weekday:'short'}).toUpperCase().replace('.','');
        
        window.app = {
            init: () => {
                app.renderCalendar();
                app.loadMatches();
                
                // Listeners Menu Mobile
                const toggleMenu = (show) => {
                    const sb = document.getElementById('sidebar');
                    const bd = document.getElementById('mobile-backdrop');
                    if(show) { sb.classList.remove('-translate-x-full'); bd.classList.remove('hidden'); }
                    else { sb.classList.add('-translate-x-full'); bd.classList.add('hidden'); }
                };
                document.getElementById('mobile-menu-btn').onclick = () => toggleMenu(true);
                document.getElementById('close-sidebar').onclick = () => toggleMenu(false);
                document.getElementById('mobile-backdrop').onclick = () => toggleMenu(false);
                
                setInterval(() => app.loadMatches(true), 60000);
            },

            toggleLive: () => {
                state.liveOnly = !state.liveOnly;
                const btn = document.getElementById('btn-live');
                if(state.liveOnly) {
                    btn.classList.add('bg-white', 'text-black', 'border-white', 'animate-pulse');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('bg-white', 'text-black', 'border-white', 'animate-pulse');
                    btn.classList.add('text-gray-500');
                }
                app.renderMatches();
            },

            switchTab: (e, targetId) => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-white', 'border-b-2', 'border-white');
                    b.classList.add('text-gray-500');
                });
                e.target.classList.add('text-white', 'border-b-2', 'border-white');
                e.target.classList.remove('text-gray-500');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');
            },

            changeDate: (days) => { state.date.setDate(state.date.getDate() + days); app.renderCalendar(); app.loadMatches(); },
            resetDate: () => { state.date = new Date(); app.renderCalendar(); app.loadMatches(); },
            
            renderCalendar: () => {
                const container = document.getElementById('calendar-days');
                const month = document.getElementById('current-month');
                const todayTxt = document.getElementById('current-day-text');
                const months = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
                month.innerText = months[state.date.getMonth()];
                const isToday = state.date.toDateString() === new Date().toDateString();
                todayTxt.innerText = isToday ? "HOY" : state.date.toLocaleDateString('es-AR', {day:'numeric', month:'short'}).toUpperCase();

                container.innerHTML = '';
                const start = new Date(state.date); start.setDate(start.getDate() - 3);
                for(let i=0; i<7; i++){
                    const d = new Date(start); d.setDate(d.getDate() + i);
                    const isSel = d.toDateString() === state.date.toDateString();
                    const div = document.createElement('div');
                    div.className = `flex flex-col items-center justify-center w-10 h-14 rounded cursor-pointer transition-all ${isSel ? 'bg-white text-black font-bold' : 'hover:bg-[#222] text-gray-500'}`;
                    div.innerHTML = `<span class="text-[9px] font-bold uppercase tracking-widest">${getDayName(d)}</span><span class="text-sm font-bold">${d.getDate()}</span>`;
                    div.onclick = () => { state.date = d; app.renderCalendar(); app.loadMatches(); };
                    container.appendChild(div);
                }
            },

            loadMatches: async (silent=false) => {
                if(!silent) document.getElementById('view-match-list').innerHTML = `<div class="flex justify-center py-20"><div class="loader"></div></div>`;
                const dateStr = formatDate(state.date);
                // IDs: LPF, CopaLPF, B Nacional, Brasileirao, Premier, LaLiga, Bundesliga, Libertadores, Sudamericana
                const targetIds = [128, 1032, 129, 71, 39, 140, 78, 13, 11]; 
                
                const data = await fetchAPI(`/fixtures?date=${dateStr}&timezone=America/Argentina/Buenos_Aires`);
                
                let matches = data.response.filter(m => targetIds.includes(m.league.id));
                matches.sort((a,b) => {
                    const isArgA = [128,1032].includes(a.league.id);
                    const isArgB = [128,1032].includes(b.league.id);
                    if(isArgA && !isArgB) return -1;
                    if(!isArgA && isArgB) return 1;
                    return a.fixture.timestamp - b.fixture.timestamp;
                });

                state.matches = matches;
                app.renderMatches();
            },

            renderMatches: () => {
                const container = document.getElementById('view-match-list');
                let list = state.matches;
                if(state.liveOnly) list = list.filter(m => ['1H','HT','2H','ET','P','LIVE'].includes(m.fixture.status.short));
                
                if(list.length === 0) {
                    container.innerHTML = `<div class="text-center py-20 text-gray-600 uppercase tracking-widest text-xs"><p>${state.liveOnly ? 'No hay partidos en vivo' : 'No hay partidos hoy'}</p></div>`;
                    return;
                }

                const groups = {};
                list.forEach(m => {
                    if(!groups[m.league.id]) groups[m.league.id] = { name: m.league.name, logo: m.league.logo, matches: [] };
                    groups[m.league.id].matches.push(m);
                });

                let html = '';
                Object.values(groups).forEach(g => {
                    html += `<div class="mb-6"><div class="px-2 py-2 flex items-center gap-3"><img src="${g.logo}" class="w-4 h-4 object-contain"><h3 class="text-xs font-bold text-white uppercase tracking-widest">${g.name}</h3></div><div class="space-y-2">`;
                    g.matches.forEach(m => {
                        const s = m.fixture.status;
                        const isLive = ['1H','2H','ET','P','LIVE'].includes(s.short);
                        const isFin = ['FT','AET','PEN'].includes(s.short);
                        const notStarted = ['NS','TBD'].includes(s.short);
                        const timeDisplay = isLive ? `<span class="text-white font-bold animate-pulse text-xs">${s.elapsed}'</span>` : (s.short === 'HT' ? 'ET' : (isFin ? 'FINAL' : new Date(m.fixture.date).toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'})));
                        let homeOp = 'opacity-100', awayOp = 'opacity-100';
                        if(!notStarted) {
                            if((m.goals.home||0) > (m.goals.away||0)) awayOp='opacity-50';
                            if((m.goals.away||0) > (m.goals.home||0)) homeOp='opacity-50';
                        }
                        
                        html += `
                        <div class="p-4 match-card ${notStarted?'not-clickable':'clickable'} relative bg-[#0a0a0a] rounded" ${notStarted?'':`onclick="app.openDetail(${m.fixture.id})"`}>
                            ${isLive ? '<div class="absolute top-3 right-3"><div class="live-dot"></div></div>' : ''}
                            <div class="flex items-center justify-between">
                                <div class="flex-1 flex justify-end items-center gap-3 ${homeOp} text-right">
                                    <span class="font-bold text-white text-sm uppercase leading-none">${m.teams.home.name}</span>
                                    <img src="${m.teams.home.logo}" class="w-8 h-8 object-contain">
                                </div>
                                <div class="px-3 flex flex-col items-center w-24 shrink-0">
                                    ${notStarted ? `<span class="text-xl font-bold text-gray-600 tracking-tighter">${timeDisplay}</span>` : 
                                    `<div class="flex gap-2 text-2xl font-black text-white tracking-widest"><span class="${homeOp}">${m.goals.home??0}</span><span class="text-gray-700">-</span><span class="${awayOp}">${m.goals.away??0}</span></div>`}
                                    <span class="text-[9px] font-bold uppercase text-gray-500 mt-1 tracking-widest">${!notStarted ? timeDisplay : ''}</span>
                                </div>
                                <div class="flex-1 flex justify-start items-center gap-3 ${awayOp} text-left">
                                    <img src="${m.teams.away.logo}" class="w-8 h-8 object-contain">
                                    <span class="font-bold text-white text-sm uppercase leading-none">${m.teams.away.name}</span>
                                </div>
                            </div>
                        </div>`;
                    });
                    html += `</div></div>`;
                });
                container.innerHTML = html;
            },

            openDetail: async (id) => {
                const m = state.matches.find(x => x.fixture.id == id);
                if(!m) return;
                document.getElementById('view-match-detail').classList.remove('hidden');
                document.getElementById('detail-content-wrapper').classList.add('hidden');
                document.getElementById('detail-loader').classList.remove('hidden');

                document.getElementById('detail-home-name').innerText = m.teams.home.name;
                document.getElementById('detail-away-name').innerText = m.teams.away.name;
                document.getElementById('detail-home-logo').src = m.teams.home.logo;
                document.getElementById('detail-away-logo').src = m.teams.away.logo;
                document.getElementById('detail-home-score').innerText = m.goals.home ?? 0;
                document.getElementById('detail-away-score').innerText = m.goals.away ?? 0;
                document.getElementById('detail-status').innerText = m.fixture.status.long;

                const data = await fetchAPI(`/fixtures?id=${id}`);
                const fullMatch = data.response[0];
                app.renderTimeline(fullMatch);
                app.renderLineups(fullMatch);
                app.renderStats(fullMatch);

                document.getElementById('detail-loader').classList.add('hidden');
                document.getElementById('detail-content-wrapper').classList.remove('hidden');
            },

            closeDetail: () => document.getElementById('view-match-detail').classList.add('hidden'),

            renderTimeline: (m) => {
                const c = document.getElementById('tab-timeline');
                const ev = m.events || [];
                if(ev.length === 0) { c.innerHTML = '<div class="text-center py-10 text-gray-600 text-xs uppercase tracking-widest">Sin eventos</div>'; return; }
                c.innerHTML = ev.map(e => `
                    <div class="flex items-center gap-4 mb-4 ${e.team.id === m.teams.home.id ? 'flex-row' : 'flex-row-reverse'}">
                        <div class="w-8 text-center text-xs font-bold text-gray-500 font-mono">${e.time.elapsed}'</div>
                        <div class="bg-[#111] border border-[#222] px-4 py-3 flex items-center gap-3 ${e.team.id === m.teams.home.id ? '' : 'flex-row-reverse text-right'} min-w-[140px]">
                            <span class="text-sm font-bold text-white">${e.player.name}</span>
                            <span class="text-[9px] px-2 py-0.5 uppercase font-bold tracking-wider ${e.type === 'Goal' ? 'bg-white text-black' : 'bg-[#333] text-gray-400'}">${e.type === 'Goal' ? 'GOL' : (e.type === 'Card' ? (e.detail === 'Yellow Card' ? 'AMA' : 'ROJA') : 'CAM')}</span>
                        </div>
                    </div>`).join('');
            },

            renderLineups: (m) => {
                const pitch = document.getElementById('football-pitch');
                pitch.querySelectorAll('.player-marker').forEach(el => el.remove());
                const hList = document.getElementById('lineup-home-list');
                const aList = document.getElementById('lineup-away-list');
                
                if(!m.lineups || m.lineups.length === 0) { hList.innerHTML = 'No data'; aList.innerHTML = 'No data'; return; }
                const homeL = m.lineups[0]; const awayL = m.lineups[1];

                hList.innerHTML = homeL.startXI.map(p => `<div class="flex justify-between border-b border-[#222] py-1.5"><span class="text-gray-300">${p.player.name}</span><span class="text-gray-600 font-mono text-xs">${p.player.number}</span></div>`).join('');
                aList.innerHTML = awayL.startXI.map(p => `<div class="flex justify-between border-b border-[#222] py-1.5"><span class="text-gray-600 font-mono text-xs">${p.player.number}</span><span class="text-gray-300">${p.player.name}</span></div>`).join('');

                const addPlayers = (players, side) => {
                    players.forEach((p, i) => {
                        const el = document.createElement('div');
                        el.className = `player-marker ${side === 'home' ? 'home-player' : 'away-player'}`;
                        el.innerText = p.player.number;
                        let x = 50, y = 50;
                        if(p.player.grid) {
                            const parts = p.player.grid.split(':');
                            const col = parseInt(parts[0]); const row = parseInt(parts[1]); 
                            if(side === 'home') x = (col * 18); else x = 100 - (col * 18);
                            y = (row * 20) + 10;
                        } else {
                            if(side === 'home') x = 10 + (i%4)*20; else x = 90 - (i%4)*20;
                            y = 10 + (i%3)*30;
                        }
                        el.style.left = x + '%'; el.style.top = y + '%';
                        pitch.appendChild(el);
                    });
                };
                addPlayers(homeL.startXI, 'home'); addPlayers(awayL.startXI, 'away');
            },

            renderStats: (m) => {
                const c = document.getElementById('tab-stats');
                if(!m.statistics || m.statistics.length === 0) { c.innerHTML = 'No data'; return; }
                const types = ['Ball Possession', 'Total Shots', 'Fouls', 'Yellow Cards'];
                const hStats = m.statistics[0].statistics; const aStats = m.statistics[1].statistics;
                c.innerHTML = types.map(t => {
                    const hVal = parseInt(hStats.find(s=>s.type===t)?.value || 0);
                    const aVal = parseInt(aStats.find(s=>s.type===t)?.value || 0);
                    const tot = hVal + aVal || 1;
                    return `<div class="bg-[#111] p-4 border border-[#222]">
                        <div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase mb-3 tracking-widest"><span>${hVal}</span><span>${t}</span><span>${aVal}</span></div>
                        <div class="h-1 bg-[#333] flex"><div class="h-full bg-white" style="width: ${(hVal/tot)*100}%"></div><div class="h-full bg-[#555]" style="width: ${(100-(hVal/tot)*100)}%"></div></div>
                    </div>`;
                }).join('');
            },

            changeSeason: (y) => { state.season = y; if(state.selectedLeague) app.showStandings(state.selectedLeague.id, state.selectedLeague.name); },

            showStandings: async (id, name) => {
                state.selectedLeague = {id, name};
                document.getElementById('view-match-list').classList.add('hidden');
                document.getElementById('date-nav').classList.add('hidden');
                document.getElementById('view-standings').classList.remove('hidden');
                document.getElementById('standings-title').innerText = name;
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-backdrop').classList.add('hidden');
                const container = document.getElementById('standings-container');
                container.innerHTML = `<div class="flex justify-center py-20"><div class="loader"></div></div>`;
                
                const data = await fetchAPI(`/standings?league=${id}&season=${state.season}`);
                // Safely handle empty responses from mock or real API
                if (!data.response || data.response.length === 0) {
                     container.innerHTML = `<div class="text-center text-gray-500 py-10 text-xs uppercase tracking-widest">Sin datos</div>`;
                     return;
                }
                const standings = data.response[0].league.standings;
                
                state.standingsData = standings;
                const tabs = document.getElementById('standings-tabs');
                if(standings.length > 1) {
                    tabs.classList.remove('hidden');
                    tabs.innerHTML = standings.map((g, i) => `<button onclick="app.renderTable(${i})" class="px-4 py-2 bg-[#111] text-xs font-bold uppercase border border-[#333] text-gray-400 hover:text-white transition-all whitespace-nowrap">${g[0].group}</button>`).join('');
                } else { tabs.classList.add('hidden'); }
                app.renderTable(0);
            },

            renderTable: (idx) => {
                const table = state.standingsData[idx];
                document.getElementById('standings-container').innerHTML = `
                <div class="bg-[#0a0a0a] border border-[#222] overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-[10px] text-gray-500 uppercase bg-[#111] border-b border-[#222] tracking-widest"><tr><th class="px-4 py-3 text-center">#</th><th class="px-3 py-3">Equipo</th><th class="px-2 py-3 text-center text-white">Pts</th><th class="px-2 py-3 text-center">PJ</th><th class="px-2 py-3 text-center">DG</th></tr></thead>
                    <tbody class="divide-y divide-[#1a1a1a]">${table.map(t => `<tr class="hover:bg-[#111]"><td class="px-4 py-3 text-center font-bold ${t.rank<=4?'text-white':'text-gray-600'}">${t.rank}</td><td class="px-3 py-3 font-bold text-gray-300 flex items-center gap-3 whitespace-nowrap text-xs"><img src="${t.team.logo}" class="w-5 h-5 object-contain">${t.team.name}</td><td class="px-2 py-3 text-center font-bold text-white">${t.points}</td><td class="px-2 py-3 text-center text-xs font-mono">${t.all.played}</td><td class="px-2 py-3 text-center text-xs font-mono">${t.goalsDiff}</td></tr>`).join('')}</tbody>
                </table></div></div>`;
            },

            navigateToMatches: () => {
                document.getElementById('view-standings').classList.add('hidden');
                document.getElementById('view-match-list').classList.remove('hidden');
                document.getElementById('date-nav').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-backdrop').classList.add('hidden');
            }
        };
        app.init();
    </script>
</body>
</html>
