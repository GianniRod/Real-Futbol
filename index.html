<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealFutbol - Resultados en Vivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #050505;
            background-image: radial-gradient(circle at top center, #111827 0%, #000000 100%);
            color: #e5e7eb;
        }
        
        /* Animaciones */
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Estilos UI */
        .match-card { transition: all 0.2s; border: 1px solid #1f2937; }
        .match-card:hover { transform: translateY(-2px); border-color: #3b82f6; background-color: rgba(30, 41, 59, 0.8); }
        
        .league-item { transition: all 0.2s; cursor: pointer; }
        .league-item:hover { background-color: #1e2937; color: #60a5fa; }
        
        .day-selected { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        
        /* Cancha */
        .football-pitch { background-color: #064e3b; border: 2px solid #525252; position: relative; width: 100%; aspect-ratio: 7 / 5; border-radius: 4px; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        .pitch-line { position: absolute; background-color: rgba(255,255,255,0.3); }
        .center-line { top: 0; bottom: 0; left: 50%; width: 1px; transform: translateX(-50%); }
        .center-circle { top: 50%; left: 50%; width: 20%; height: 28%; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; transform: translate(-50%, -50%); }
        .penalty-box { position: absolute; border: 1px solid rgba(255,255,255,0.3); width: 15%; height: 40%; top: 30%; }
        .home-box { left: 0; border-left: none; }
        .away-box { right: 0; border-right: none; }

        .player-marker { position: absolute; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 11px; border: 2px solid rgba(255, 255, 255, 0.9); cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 10; }
        .player-marker:hover { transform: scale(1.2) translate(-40%, -40%); z-index: 20; border-color: #fbbf24; }
        .home-player { background: radial-gradient(circle at 30% 30%, #ef4444, #991b1b); }
        .away-player { background: radial-gradient(circle at 30% 30%, #3b82f6, #1e40af); }

        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #3b82f6; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .font-tnum { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="h-16 bg-black/60 backdrop-blur-md border-b border-gray-800 flex items-center px-4 justify-between z-30 shrink-0">
        <div class="flex items-center gap-3">
            <button id="mobile-menu-btn" class="lg:hidden text-gray-400 hover:text-white">
                <i data-lucide="menu"></i>
            </button>
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-1.5 rounded-lg">
                    <i data-lucide="trophy" class="w-5 h-5 text-white"></i>
                </div>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">RealFutbol</h1>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="live-indicator" class="hidden flex items-center gap-2 bg-red-500/10 px-3 py-1 rounded-full border border-red-500/20">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                </span>
                <span class="text-xs font-bold text-red-500 tracking-wider">EN VIVO</span>
            </div>
            <img src="https://i.pravatar.cc/150?u=a042581f4e29026024d" alt="User" class="w-8 h-8 rounded-full border border-gray-700">
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-full lg:w-72 xl:w-80 bg-[#0a0a0a] border-r border-gray-800 flex flex-col absolute lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-20">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center lg:hidden">
                <h2 class="font-bold text-gray-200">Competencias</h2>
                <button id="close-sidebar" class="text-gray-400"><i data-lucide="x"></i></button>
            </div>
            
            <div class="overflow-y-auto flex-1 p-2 space-y-1">
                <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Torneos Destacados</div>
                
                <button onclick="app.showStandings(128, 'Liga Profesional Arg')" class="league-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left text-gray-300">
                    <img src="https://media.api-sports.io/football/leagues/128.png" class="w-6 h-6 object-contain" onerror="this.src='https://via.placeholder.com/20'">
                    <span class="text-sm font-medium">Liga Profesional</span>
                </button>

                <button onclick="app.showStandings(129, 'Primera Nacional')" class="league-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left text-gray-300">
                    <img src="https://media.api-sports.io/football/leagues/129.png" class="w-6 h-6 object-contain" onerror="this.src='https://via.placeholder.com/20'">
                    <span class="text-sm font-medium">Primera Nacional</span>
                </button>

                <button onclick="app.showStandings(13, 'Copa Libertadores')" class="league-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left text-gray-300">
                    <img src="https://media.api-sports.io/football/leagues/13.png" class="w-6 h-6 object-contain" onerror="this.src='https://via.placeholder.com/20'">
                    <span class="text-sm font-medium">Copa Libertadores</span>
                </button>

                <button onclick="app.showStandings(11, 'Copa Sudamericana')" class="league-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left text-gray-300">
                    <img src="https://media.api-sports.io/football/leagues/11.png" class="w-6 h-6 object-contain" onerror="this.src='https://via.placeholder.com/20'">
                    <span class="text-sm font-medium">Copa Sudamericana</span>
                </button>

                <button onclick="app.showStandings(71, 'Brasileirão Série A')" class="league-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left text-gray-300">
                    <img src="https://media.api-sports.io/football/leagues/71.png" class="w-6 h-6 object-contain" onerror="this.src='https://via.placeholder.com/20'">
                    <span class="text-sm font-medium">Brasileirão Série A</span>
                </button>
                
                <button onclick="app.showStandings(1032, 'Copa de la Liga')" class="league-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left text-gray-300">
                    <img src="https://media.api-sports.io/football/leagues/1032.png" class="w-6 h-6 object-contain" onerror="this.src='https://via.placeholder.com/20'">
                    <span class="text-sm font-medium">Copa de la Liga</span>
                </button>

                 <div class="px-3 py-2 mt-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Internacional</div>
                 <button onclick="app.showStandings(140, 'La Liga')" class="league-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left text-gray-300">
                    <img src="https://media.api-sports.io/football/leagues/140.png" class="w-6 h-6 object-contain">
                    <span class="text-sm font-medium">La Liga (España)</span>
                </button>
                 <button onclick="app.showStandings(39, 'Premier League')" class="league-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left text-gray-300">
                    <img src="https://media.api-sports.io/football/leagues/39.png" class="w-6 h-6 object-contain">
                    <span class="text-sm font-medium">Premier League</span>
                </button>

                <div class="mt-8 px-4">
                    <button onclick="app.navigateToMatches()" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors border border-gray-700">
                        <i data-lucide="calendar"></i>
                        Ver Partidos de Hoy
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-black relative w-full lg:w-auto overflow-hidden">
            
            <!-- Date Navigation -->
            <div id="date-nav" class="bg-[#0a0a0a]/90 backdrop-blur border-b border-gray-800 p-3 z-10 sticky top-0">
                <div class="flex items-center justify-between mb-2 max-w-2xl mx-auto">
                    <button onclick="app.changeDate(-1)" class="p-2 hover:bg-gray-800 rounded-full text-gray-400 hover:text-white transition-colors"><i data-lucide="chevron-left"></i></button>
                    <div class="text-center cursor-pointer" onclick="app.resetDate()">
                        <h2 id="current-month" class="text-xs text-blue-400 font-bold uppercase tracking-wide">NOVIEMBRE</h2>
                        <div id="current-day-text" class="text-lg font-bold text-white">Hoy</div>
                    </div>
                    <button onclick="app.changeDate(1)" class="p-2 hover:bg-gray-800 rounded-full text-gray-400 hover:text-white transition-colors"><i data-lucide="chevron-right"></i></button>
                </div>
                <div id="calendar-days" class="flex justify-between max-w-2xl mx-auto gap-1"></div>
            </div>

            <!-- Content Container -->
            <div id="main-content" class="flex-1 overflow-y-auto p-4 lg:p-6 relative">
                
                <!-- Match List -->
                <div id="view-match-list" class="max-w-3xl mx-auto space-y-4 animate-fade-in pb-20"></div>

                <!-- Standings View -->
                <div id="view-standings" class="hidden max-w-4xl mx-auto animate-fade-in pb-20">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
                        <div class="flex items-center gap-4">
                            <button onclick="app.navigateToMatches()" class="lg:hidden p-2 bg-gray-800 rounded-lg"><i data-lucide="arrow-left"></i></button>
                            <h2 id="standings-title" class="text-2xl font-bold text-white">Tabla de Posiciones</h2>
                        </div>
                        
                        <!-- Season Selector -->
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-400">Temporada:</label>
                            <select id="season-selector" onchange="app.changeSeason(this.value)" class="bg-gray-800 text-white text-sm rounded-lg border border-gray-700 p-2 focus:border-blue-500 focus:outline-none">
                                <option value="2023" selected>2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                            </select>
                        </div>
                    </div>
                    <!-- El contenedor de tablas se inyectará aquí dinámicamente -->
                    <div id="standings-container" class="space-y-8"></div>
                </div>

                <!-- Match Detail Overlay -->
                <div id="view-match-detail" class="hidden fixed inset-0 lg:absolute lg:inset-0 bg-black z-40 lg:z-10 overflow-y-auto animate-fade-in">
                    <div class="max-w-4xl mx-auto min-h-full bg-[#050505] lg:border-l lg:border-gray-800 shadow-2xl">
                        <!-- Header Detail -->
                        <div class="sticky top-0 z-50 bg-black/80 backdrop-blur-md border-b border-gray-800 p-4 flex items-center gap-4">
                            <button onclick="app.closeDetail()" class="p-2 hover:bg-gray-800 rounded-lg transition-colors text-white">
                                <i data-lucide="arrow-left"></i>
                            </button>
                            <span class="font-bold text-lg text-white">Detalles del Partido</span>
                        </div>
                        <!-- Scoreboard -->
                        <div class="relative bg-gradient-to-b from-gray-900 to-black p-8 text-center border-b border-gray-800">
                            <div class="flex justify-between items-center max-w-2xl mx-auto">
                                <div class="flex-1 flex flex-col items-center gap-2">
                                    <img id="detail-home-logo" src="" class="w-20 h-20 object-contain drop-shadow-lg">
                                    <h3 id="detail-home-name" class="font-bold text-lg leading-tight">Home</h3>
                                </div>
                                <div class="px-4">
                                    <div class="text-5xl font-black text-white tracking-tighter flex items-center gap-3">
                                        <span id="detail-home-score" class="font-tnum">-</span>
                                        <span class="text-gray-600 text-3xl">:</span>
                                        <span id="detail-away-score" class="font-tnum">-</span>
                                    </div>
                                    <div id="detail-status" class="mt-2 inline-block px-3 py-1 rounded-full bg-gray-800 text-xs font-bold text-blue-400 border border-gray-700">VS</div>
                                </div>
                                <div class="flex-1 flex flex-col items-center gap-2">
                                    <img id="detail-away-logo" src="" class="w-20 h-20 object-contain drop-shadow-lg">
                                    <h3 id="detail-away-name" class="font-bold text-lg leading-tight">Away</h3>
                                </div>
                            </div>
                        </div>
                        <!-- Tabs -->
                        <div class="flex border-b border-gray-800 sticky top-[73px] bg-black z-40">
                            <button class="flex-1 py-4 text-sm font-bold text-blue-500 border-b-2 border-blue-500 tab-btn" data-target="tab-timeline">Resumen</button>
                            <button class="flex-1 py-4 text-sm font-bold text-gray-500 hover:text-gray-300 tab-btn" data-target="tab-lineups">Alineaciones</button>
                            <button class="flex-1 py-4 text-sm font-bold text-gray-500 hover:text-gray-300 tab-btn" data-target="tab-stats">Estadísticas</button>
                            <button class="flex-1 py-4 text-sm font-bold text-gray-500 hover:text-gray-300 tab-btn" data-target="tab-chat">Chat</button>
                        </div>
                        <!-- Tab Content -->
                        <div class="p-4 lg:p-8 space-y-6 min-h-[50vh]">
                            <div id="tab-timeline" class="tab-content block space-y-4"></div>
                            <div id="tab-lineups" class="tab-content hidden">
                                <div class="football-pitch mx-auto max-w-lg" id="football-pitch">
                                    <div class="center-line"></div>
                                    <div class="center-circle"></div>
                                    <div class="penalty-box home-box"></div>
                                    <div class="penalty-box away-box"></div>
                                </div>
                            </div>
                            <div id="tab-stats" class="tab-content hidden space-y-6"></div>
                            <div id="tab-chat" class="tab-content hidden flex flex-col h-[500px]">
                                <div id="chat-messages" class="flex-1 overflow-y-auto space-y-3 p-2 bg-gray-900/30 rounded-lg border border-gray-800 mb-4">
                                    <div class="text-center text-gray-600 mt-10">
                                        <i data-lucide="message-square" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
                                        <p>Comenta el partido con otros hinchas.</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="chat-input" placeholder="Escribe tu mensaje..." class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 transition-colors">
                                    <button id="chat-send" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg px-6 font-bold transition-colors">Enviar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Player Modal -->
    <div id="player-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="bg-gradient-to-r from-gray-800 to-gray-900 p-4 flex justify-between items-center border-b border-gray-700">
                <h3 id="modal-player-name" class="font-bold text-white text-lg">Nombre Jugador</h3>
                <button onclick="document.getElementById('player-modal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center border-2 border-blue-500 overflow-hidden">
                        <i data-lucide="user" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Dorsal</p>
                        <p id="modal-player-number" class="text-2xl font-bold text-white">#10</p>
                    </div>
                </div>
                <div class="border-t border-gray-800 pt-4">
                    <p class="text-xs text-gray-500 uppercase font-bold mb-2">Comentarios sobre el jugador</p>
                    <div id="player-comments-list" class="h-32 overflow-y-auto space-y-2 mb-3 bg-black/20 p-2 rounded"></div>
                    <div class="flex gap-2">
                        <input type="text" id="player-comment-input" class="flex-1 bg-gray-800 text-sm rounded px-2 py-1 border border-gray-700" placeholder="Opinar...">
                        <button id="player-comment-send" class="bg-blue-600 text-white text-xs px-3 rounded hover:bg-blue-500">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- CONFIG & UTILS ---
        const API_KEY = "160002c02e969ea355717b6ec7267fa7";
        const API_BASE = "https://v3.football.api-sports.io"; 
        
        const firebaseConfig = { apiKey: "AIza...", authDomain: "demo.firebaseapp.com", projectId: "demo" };
        let db, auth;
        try { 
            const fApp = initializeApp(firebaseConfig); 
            db = getFirestore(fApp); 
            auth = getAuth(fApp); 
            signInAnonymously(auth).catch(e => console.log("Auth anónima:", e));
        } catch (e) { console.log("Firebase no configurado (Modo Demo)"); }

        const state = {
            currentDate: new Date(),
            matches: [],
            selectedMatch: null,
            view: 'matches',
            loading: false,
            currentLeagueId: null, // Para guardar qué liga estamos viendo
            currentLeagueName: null,
            currentSeason: 2023 // Default a 2023 para plan free
        };

        window.app = {
            init: () => {
                lucide.createIcons();
                app.renderCalendarDays();
                app.loadMatches();
                
                // Listeners Generales
                document.getElementById('mobile-menu-btn').onclick = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');
                document.getElementById('close-sidebar').onclick = () => document.getElementById('sidebar').classList.add('-translate-x-full');
                
                // Tab switching logic
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab-btn').forEach(b => {
                            b.classList.remove('text-blue-500', 'border-b-2', 'border-blue-500');
                            b.classList.add('text-gray-500');
                        });
                        e.target.classList.add('text-blue-500', 'border-b-2', 'border-blue-500');
                        e.target.classList.remove('text-gray-500');
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                        document.getElementById(e.target.dataset.target).classList.remove('hidden');
                    });
                });

                setInterval(() => app.loadMatches(true), 60000);
            },

            // --- DATE LOGIC ---
            getArgDateString: (dateObj) => {
                return dateObj.toLocaleDateString('en-CA', { 
                    timeZone: 'America/Argentina/Buenos_Aires',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            },

            getArgDateComponents: (dateObj) => {
                const formatter = new Intl.DateTimeFormat('es-AR', {
                    timeZone: 'America/Argentina/Buenos_Aires',
                    weekday: 'short',
                    day: 'numeric',
                    month: 'long'
                });
                const parts = formatter.formatToParts(dateObj);
                return {
                    day: parts.find(p => p.type === 'day').value,
                    weekday: parts.find(p => p.type === 'weekday').value,
                    month: parts.find(p => p.type === 'month').value
                };
            },

            changeDate: (days) => {
                state.currentDate.setDate(state.currentDate.getDate() + days);
                app.renderCalendarDays();
                app.loadMatches();
            },

            resetDate: () => {
                state.currentDate = new Date();
                app.renderCalendarDays();
                app.loadMatches();
            },

            renderCalendarDays: () => {
                const container = document.getElementById('calendar-days');
                const monthTitle = document.getElementById('current-month');
                const todayText = document.getElementById('current-day-text');
                
                const argComponents = app.getArgDateComponents(state.currentDate);
                monthTitle.innerText = argComponents.month;
                
                const todayArg = app.getArgDateString(new Date());
                const currentArg = app.getArgDateString(state.currentDate);

                if (todayArg === currentArg) {
                    todayText.innerText = "Partidos de Hoy";
                } else {
                    todayText.innerText = `${argComponents.weekday} ${argComponents.day}`;
                }

                container.innerHTML = '';
                const startDay = new Date(state.currentDate);
                startDay.setDate(startDay.getDate() - 3);

                const daysOfWeek = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];

                for (let i = 0; i < 7; i++) {
                    const d = new Date(startDay);
                    d.setDate(d.getDate() + i);
                    
                    const dArgString = app.getArgDateString(d);
                    const isSelected = dArgString === currentArg;
                    const dComponents = app.getArgDateComponents(d);

                    const dayEl = document.createElement('div');
                    dayEl.className = `flex flex-col items-center justify-center w-10 h-14 rounded-lg cursor-pointer transition-all ${isSelected ? 'day-selected' : 'hover:bg-gray-800 text-gray-500'}`;
                    
                    dayEl.innerHTML = `
                        <span class="text-[10px] font-bold uppercase">${dComponents.weekday.substring(0,3)}</span>
                        <span class="text-sm font-bold">${dComponents.day}</span>
                    `;
                    
                    dayEl.onclick = () => {
                        state.currentDate = d;
                        app.renderCalendarDays();
                        app.loadMatches();
                    };
                    container.appendChild(dayEl);
                }
            },

            loadMatches: async (silent = false) => {
                if (!silent) document.getElementById('view-match-list').innerHTML = `<div class="flex justify-center py-20"><div class="loader"></div></div>`;
                
                const dateStr = app.getArgDateString(state.currentDate);
                
                try {
                    // Nota: para que aparezcan goleadores en la LISTA, la API suele necesitar "fixtures?id=X", 
                    // pero en la llamada masiva por fecha a veces no los incluye.
                    // Si el plan lo permite, vendrán en 'events'. Si no, no se mostrarán (graceful degradation).
                    const res = await fetch(`${API_BASE}/fixtures?timezone=America/Argentina/Buenos_Aires&date=${dateStr}`, {
                        headers: { "x-apisports-key": API_KEY }
                    });
                    const data = await res.json();
                    
                    if (data.errors && Object.keys(data.errors).length > 0) throw new Error("API Limit");
                    
                    const priorityLeagues = [128, 129, 13, 11, 71, 1032, 1, 2, 39, 140, 9, 10]; 
                    
                    let matches = data.response.filter(m => 
                        priorityLeagues.includes(m.league.id) || 
                        m.league.country === "Argentina" || 
                        m.teams.home.name.includes('Argentina') ||
                        m.teams.away.name.includes('Argentina')
                    );

                    matches.sort((a, b) => a.fixture.timestamp - b.fixture.timestamp);
                    state.matches = matches;
                    app.renderMatches(matches);
                } catch (err) {
                    console.error(err);
                    document.getElementById('view-match-list').innerHTML = `<div class="text-center text-gray-500 py-10">
                        <p>No se pudieron cargar los partidos.</p>
                        <p class="text-xs mt-2 text-gray-600">Verifica tu conexión o cuota de API.</p>
                    </div>`;
                }
            },

            renderMatches: (matches) => {
                const container = document.getElementById('view-match-list');
                if (matches.length === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center py-20 text-gray-600"><i data-lucide="calendar-x" class="w-12 h-12 mb-4"></i><p>No hay partidos destacados hoy.</p></div>`;
                    lucide.createIcons();
                    return;
                }

                const leagues = {};
                matches.forEach(m => {
                    if (!leagues[m.league.id]) leagues[m.league.id] = { meta: m.league, matches: [] };
                    leagues[m.league.id].matches.push(m);
                });

                let html = '';
                const sortedLeagueIds = Object.keys(leagues).sort((a,b) => (a == 128 ? -1 : 0));

                sortedLeagueIds.forEach(id => {
                    const group = leagues[id];
                    html += `<div class="mb-6"><div class="flex items-center gap-2 mb-3 px-2"><img src="${group.meta.logo}" class="w-5 h-5 object-contain" onerror="this.style.display='none'"><h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">${group.meta.name}</h3></div><div class="grid gap-3">`;
                    
                    group.matches.forEach(m => {
                        const status = m.fixture.status.short;
                        const isLive = ['1H', '2H', 'HT', 'ET', 'P'].includes(status);
                        const isFinished = ['FT', 'AET', 'PEN'].includes(status);
                        const statusLabel = status === 'HT' ? 'ENTRETIEMPO' : (isLive ? m.fixture.status.elapsed + "'" : m.fixture.status.long);
                        
                        let homeScoreClass = 'text-white';
                        let awayScoreClass = 'text-white';
                        
                        if (isLive || isFinished) {
                            const homeG = m.goals.home || 0;
                            const awayG = m.goals.away || 0;
                            if (homeG < awayG) homeScoreClass = 'text-white/50';
                            if (awayG < homeG) awayScoreClass = 'text-white/50';
                        }
                        
                        // Lógica de Goleadores (si la API trae 'events' en el listado)
                        let homeScorers = [];
                        let awayScorers = [];
                        
                        if (m.events && m.events.length > 0) {
                            m.events.forEach(e => {
                                if (e.type === 'Goal') {
                                    const scorerName = e.player.name.split(' ').pop(); // Solo apellido o último nombre para ahorrar espacio
                                    const time = e.time.elapsed + (e.time.extra ? `+${e.time.extra}` : '') + "'";
                                    if (e.team.id === m.teams.home.id) homeScorers.push(`${scorerName} ${time}`);
                                    if (e.team.id === m.teams.away.id) awayScorers.push(`${scorerName} ${time}`);
                                }
                            });
                        }

                        const time = new Date(m.fixture.date).toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'});
                        
                        html += `
                        <div onclick="app.openDetail(${m.fixture.id})" class="match-card bg-[#111] rounded-xl p-4 cursor-pointer relative overflow-hidden group">
                            ${isLive ? '<div class="absolute top-0 right-0 bg-red-600 text-[10px] font-bold px-2 py-0.5 rounded-bl-lg text-white animate-pulse">EN VIVO</div>' : ''}
                            
                            <!-- Main Row -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3 flex-1">
                                    <span class="font-semibold text-gray-200 text-right truncate flex-1">${m.teams.home.name}</span>
                                    <img src="${m.teams.home.logo}" class="w-8 h-8 object-contain">
                                </div>
                                <div class="px-4 flex flex-col items-center w-28">
                                    ${status === 'NS' 
                                        ? `<span class="text-xl font-bold text-gray-500">${time}</span>` 
                                        : `<div class="flex gap-2 text-2xl font-black">
                                            <span class="${homeScoreClass}">${m.goals.home ?? 0}</span><span class="text-gray-600">-</span><span class="${awayScoreClass}">${m.goals.away ?? 0}</span>
                                           </div>`
                                    }
                                    <span class="text-[10px] font-bold mt-1 ${isLive ? 'text-red-500' : 'text-gray-500'} uppercase">${statusLabel}</span>
                                </div>
                                <div class="flex items-center gap-3 flex-1">
                                    <img src="${m.teams.away.logo}" class="w-8 h-8 object-contain">
                                    <span class="font-semibold text-gray-200 truncate flex-1">${m.teams.away.name}</span>
                                </div>
                            </div>
                            
                            <!-- Goleadores Row (Solo si hay goles) -->
                            ${(homeScorers.length > 0 || awayScorers.length > 0) ? `
                                <div class="flex justify-between items-start mt-3 pt-2 border-t border-gray-800 text-[10px] text-gray-400">
                                    <div class="flex-1 text-right pr-12 leading-tight">
                                        ${homeScorers.join('<br>')}
                                    </div>
                                    <div class="flex-1 text-left pl-12 leading-tight">
                                        ${awayScorers.join('<br>')}
                                    </div>
                                </div>
                            ` : ''}

                        </div>`;
                    });
                    html += `</div></div>`;
                });
                container.innerHTML = html;
            },

            openDetail: (fixtureId) => {
                const match = state.matches.find(m => m.fixture.id === fixtureId);
                if (!match) return;
                state.selectedMatch = match;
                
                document.getElementById('detail-home-name').innerText = match.teams.home.name;
                document.getElementById('detail-away-name').innerText = match.teams.away.name;
                document.getElementById('detail-home-logo').src = match.teams.home.logo;
                document.getElementById('detail-away-logo').src = match.teams.away.logo;
                document.getElementById('detail-home-score').innerText = match.goals.home ?? 0;
                document.getElementById('detail-away-score').innerText = match.goals.away ?? 0;
                
                const status = match.fixture.status.short;
                const statusLabel = status === 'HT' ? 'ENTRETIEMPO' : match.fixture.status.long;
                document.getElementById('detail-status').innerText = statusLabel;

                const homeG = match.goals.home || 0;
                const awayG = match.goals.away || 0;
                const homeScoreEl = document.getElementById('detail-home-score');
                const awayScoreEl = document.getElementById('detail-away-score');
                
                homeScoreEl.className = 'font-tnum ' + (homeG < awayG ? 'text-white/50' : 'text-white');
                awayScoreEl.className = 'font-tnum ' + (awayG < homeG ? 'text-white/50' : 'text-white');

                const timelineContainer = document.getElementById('tab-timeline');
                if (match.events && match.events.length > 0) {
                    timelineContainer.innerHTML = match.events.map(e => `
                        <div class="flex items-center gap-4 ${e.team.id === match.teams.home.id ? 'flex-row' : 'flex-row-reverse'}">
                            <div class="w-12 text-center text-sm font-bold text-gray-500">${e.time.elapsed}'</div>
                            <div class="flex-1 bg-gray-900 p-3 rounded-lg border border-gray-800 flex items-center gap-3 ${e.team.id === match.teams.home.id ? '' : 'justify-end'}">
                                <span class="text-sm font-medium text-white">${e.player.name}</span>
                                <span class="text-xs px-2 py-1 rounded bg-gray-800 text-gray-400 uppercase border border-gray-700">${e.type}</span>
                            </div>
                        </div>`).join('');
                } else {
                    timelineContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay eventos disponibles aún.</p>`;
                }

                app.renderLineupsMock(match);
                document.getElementById('view-match-detail').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            },

            closeDetail: () => {
                document.getElementById('view-match-detail').classList.add('hidden');
                document.body.style.overflow = '';
                state.selectedMatch = null;
            },

            renderLineupsMock: (match) => {
                const pitch = document.getElementById('football-pitch');
                pitch.querySelectorAll('.player-marker').forEach(m => m.remove());
                // Mock simple
                const homePositions = [{top:'45%',left:'5%'},{top:'10%',left:'20%'},{top:'35%',left:'20%'},{top:'55%',left:'20%'},{top:'80%',left:'20%'},{top:'10%',left:'40%'},{top:'35%',left:'40%'},{top:'55%',left:'40%'},{top:'80%',left:'40%'},{top:'35%',left:'60%'},{top:'55%',left:'60%'}];
                homePositions.forEach((pos, i) => {
                    const el = document.createElement('div'); el.className = 'player-marker home-player'; el.style.top = pos.top; el.style.left = pos.left; el.innerText = i + 1; el.onclick = () => app.openPlayerModal(match.teams.home.name + " Player " + (i+1)); pitch.appendChild(el);
                });
                const awayPositions = [{top:'45%',right:'5%'},{top:'10%',right:'20%'},{top:'35%',right:'20%'},{top:'55%',right:'20%'},{top:'80%',right:'20%'},{top:'10%',right:'40%'},{top:'35%',right:'40%'},{top:'55%',right:'40%'},{top:'80%',right:'40%'},{top:'35%',right:'60%'},{top:'55%',right:'60%'}];
                awayPositions.forEach((pos, i) => {
                    const el = document.createElement('div'); el.className = 'player-marker away-player'; el.style.top = pos.top; el.style.right = pos.right; el.innerText = i + 1; el.onclick = () => app.openPlayerModal(match.teams.away.name + " Player " + (i+1)); pitch.appendChild(el);
                });
            },

            // --- STANDINGS Lógica Modificada ---
            changeSeason: (year) => {
                state.currentSeason = year;
                if (state.currentLeagueId) {
                    app.showStandings(state.currentLeagueId, state.currentLeagueName);
                }
            },

            showStandings: async (leagueId, leagueName) => {
                // Guardar estado actual
                state.currentLeagueId = leagueId;
                state.currentLeagueName = leagueName;
                
                document.getElementById('view-match-list').classList.add('hidden');
                document.getElementById('date-nav').classList.add('hidden');
                document.getElementById('view-standings').classList.remove('hidden');
                document.getElementById('standings-title').innerText = leagueName;
                document.getElementById('sidebar').classList.add('-translate-x-full');
                
                // Actualizar selector visualmente si venimos de un clic directo
                document.getElementById('season-selector').value = state.currentSeason;

                const container = document.getElementById('standings-container');
                container.innerHTML = `<div class="flex justify-center py-20"><div class="loader"></div></div>`;

                try {
                    const res = await fetch(`${API_BASE}/standings?league=${leagueId}&season=${state.currentSeason}`, {
                        headers: { "x-apisports-key": API_KEY }
                    });
                    const data = await res.json();
                    
                    if (!data.response || data.response.length === 0) {
                        throw new Error("No hay datos disponibles para la temporada " + state.currentSeason);
                    }

                    const leagueData = data.response[0].league;
                    const allStandings = leagueData.standings;

                    let tablesHtml = '';
                    allStandings.forEach((group) => {
                        const groupTitle = group[0].group !== leagueData.name ? group[0].group : '';
                        tablesHtml += `
                        <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-2xl mb-6">
                            ${groupTitle ? `<div class="bg-gray-800/50 px-4 py-2 text-sm font-bold text-blue-400 border-b border-gray-800">${groupTitle}</div>` : ''}
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-400">
                                    <thead class="text-xs text-gray-300 uppercase bg-gray-800 border-b border-gray-700">
                                        <tr>
                                            <th class="px-3 py-3 text-center">#</th>
                                            <th class="px-3 py-3">Equipo</th>
                                            <th class="px-3 py-3 text-center">PJ</th>
                                            <th class="px-3 py-3 text-center font-bold text-white">Pts</th>
                                            <th class="px-3 py-3 text-center hidden md:table-cell">DG</th>
                                            <th class="px-3 py-3 text-center hidden sm:table-cell">Forma</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${group.map(t => `
                                            <tr class="border-b border-gray-800 hover:bg-gray-800/50 transition-colors">
                                                <td class="px-3 py-3 text-center font-bold ${t.rank <= 4 ? 'text-blue-400' : 'text-gray-500'}">${t.rank}</td>
                                                <td class="px-3 py-3 font-medium text-white flex items-center gap-2 whitespace-nowrap">
                                                    <img src="${t.team.logo}" class="w-5 h-5 object-contain"> ${t.team.name}
                                                </td>
                                                <td class="px-3 py-3 text-center">${t.all.played}</td>
                                                <td class="px-3 py-3 text-center font-bold text-white text-lg">${t.points}</td>
                                                <td class="px-3 py-3 text-center hidden md:table-cell text-gray-400 font-tnum">${t.goalsDiff > 0 ? '+'+t.goalsDiff : t.goalsDiff}</td>
                                                <td class="px-3 py-3 text-center hidden sm:table-cell">
                                                    <div class="flex justify-center gap-1">
                                                        ${(t.form || '').split('').slice(-5).map(char => {
                                                            let color = 'bg-gray-600';
                                                            if (char === 'W') color = 'bg-green-500';
                                                            if (char === 'L') color = 'bg-red-500';
                                                            if (char === 'D') color = 'bg-yellow-500';
                                                            return `<div class="w-1.5 h-1.5 rounded-full ${color}" title="${char}"></div>`;
                                                        }).join('')}
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    });

                    container.innerHTML = tablesHtml;

                } catch (e) {
                    console.error(e);
                    container.innerHTML = `<div class="text-center text-gray-400 py-8">
                        <p class="font-bold text-lg mb-2">Sin datos disponibles</p>
                        <p class="text-sm opacity-70">No se encontraron tablas para la temporada ${state.currentSeason}.</p>
                    </div>`;
                }
            },

            navigateToMatches: () => {
                document.getElementById('view-standings').classList.add('hidden');
                document.getElementById('view-match-list').classList.remove('hidden');
                document.getElementById('date-nav').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('-translate-x-full');
            },

            openPlayerModal: (playerName) => {
                document.getElementById('modal-player-name').innerText = playerName;
                document.getElementById('player-modal').classList.remove('hidden');
            }
        };

        app.init();
    </script>
</body>
</html>
